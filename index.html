<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Calendar with Interval Scheduling Algorithm</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #138808;
            --primary-dark: #0f7006;
            --secondary: #ff9933;
            --accent: #9c27b0;
            --danger: #ef4444;
            --light: #f8f9fa;
            --dark: #333;
            --gray: #6c757d;
        }

        body {
            background: linear-gradient(135deg, var(--secondary) 0%, #ffffff 50%, var(--primary) 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            min-height: 95vh;
        }

        header {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, var(--secondary) 0%, #ffffff 50%, var(--primary) 100%);
            color: var(--dark);
            position: relative;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            color: #555;
        }

        .tricolor {
            height: 8px;
            background: linear-gradient(90deg, var(--secondary) 33%, #ffffff 33%, #ffffff 66%, var(--primary) 66%);
            margin: 20px 0;
            border-radius: 4px;
        }

        /* Navigation Styles */
        nav {
            background: var(--light);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 600;
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            background: var(--primary);
            color: white;
        }

        .user-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 2px solid #d1d5db;
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Page Content Styles */
        .page-content {
            padding: 30px;
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* Dashboard Styles */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid var(--primary);
        }

        .stat-card i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .stat-card p {
            color: var(--gray);
            font-weight: 500;
        }

        .upcoming-events {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .upcoming-events h2 {
            margin-bottom: 20px;
            color: var(--primary);
            border-bottom: 2px solid var(--light);
            padding-bottom: 10px;
        }

        .event-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .event-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
            transition: all 0.3s;
        }

        .event-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .event-date {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 80px;
            margin-right: 15px;
        }

        .event-date .day {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .event-date .month {
            font-size: 0.9rem;
        }

        .event-details {
            flex: 1;
        }

        .event-details h4 {
            margin-bottom: 5px;
            color: var(--dark);
        }

        .event-details p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .event-category {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--secondary);
            color: white;
        }

        /* Calendar Styles */
        .calendar-container {
            padding: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .calendar-header h2 {
            font-size: 2rem;
            color: var(--primary);
            font-weight: 700;
        }
        .calendar-day.empty-day {
    background: #f8f9fa;
    border: 2px dashed #e9ecef;
}

.calendar-day.empty-day .empty-state {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 10px;
}

.event-count {
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    position: absolute;
    top: 8px;
    right: 8px;
}

        .calendar-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .calendar-nav button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .calendar-nav button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .view-options {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        .week-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            text-align: center;
            font-weight: 700;
            margin-bottom: 15px;
            background: #f0f4ff;
            padding: 15px;
            border-radius: 12px;
            color: var(--primary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day {
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: #fafbff;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }

        .calendar-day:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            background: #fff;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px dashed #e9ecef;
        }

        .day-number {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--dark);
        }

        .add-event-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .calendar-day:hover .add-event-btn {
            opacity: 1;
        }

        .today {
            background: #e6f7ff;
            border-color: var(--primary);
        }

        .today .day-number {
            background: var(--primary);
            color: white;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .events-container {
            max-height: 100px;
            overflow-y: auto;
        }

        .event {
            background: var(--primary);
            color: white;
            padding: 6px 8px;
            border-radius: 6px;
            margin-top: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .event:hover {
            transform: scale(1.02);
            opacity: 0.9;
        }

        .event-festival {
            background: var(--accent);
        }

        .event-holiday {
            background: var(--secondary);
        }

        .event-national {
            background: var(--primary);
        }

        .event-personal {
            background: #3b82f6;
        }

        .event-count {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .festival-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: var(--secondary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Form Styles */
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .form-header h2 {
            color: var(--primary);
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(19, 136, 8, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .photo-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload:hover {
            border-color: var(--primary);
            background: #f0f9f0;
        }

        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light);
            color: #374151;
            border: 2px solid #d1d5db;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
            font-size: 1rem;
        }

        /* Profile Styles */
        .profile-container {
            display: flex;
            gap: 30px;
        }

        .profile-sidebar {
            width: 300px;
            background: var(--light);
            border-radius: 15px;
            padding: 25px;
            height: fit-content;
        }

        .profile-content {
            flex: 1;
            background: var(--light);
            border-radius: 15px;
            padding: 25px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--primary);
        }

        .profile-info h2 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .profile-info p {
            color: #666;
        }

        .profile-menu {
            list-style: none;
        }

        .profile-menu li {
            margin-bottom: 10px;
        }

        .profile-menu a {
            display: block;
            padding: 15px;
            text-decoration: none;
            color: var(--dark);
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .profile-menu a:hover, .profile-menu a.active {
            background: var(--primary);
            color: white;
        }

        .profile-section {
            display: none;
        }

        .profile-section.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .event-details {
            margin-top: 20px;
        }

        .event-image {
            width: 100%;
            height: 110px;
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .event-info {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .event-info h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }

        .info-value {
            color: var(--dark);
            font-weight: 500;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: var(--primary);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--secondary);
        }
input#emailUpdates {
    width: 20px;
    height: 15px;
}
/* Enhanced styles for event images */
.event-image {
    width: 100%;
    height: 110px;
    max-height: 300px;
    object-fit: cover;
    border-radius: 12px;
    margin-bottom: 20px;
    transition: transform 0.3s ease;
}

.event-image:hover {
    transform: scale(1.02);
}

.holiday-image {
    width: 100%;
    border-radius: 10px;
    object-fit: cover;
    max-height: 200px;
    transition: transform 0.3s ease;
}

.holiday-image:hover {
    transform: scale(1.05);
}

/* Loading state for images */
.event-image.loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Responsive images */
@media (max-width: 768px) {
    .event-image {
        max-height: 200px;
    }
    
    .holiday-image {
        max-height: 150px;
    }
}
        /* AI Assistant Styles */
        .ai-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .ai-toggle {
            background: var(--accent);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .ai-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .ai-chat-container {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-chat-container.active {
            display: flex;
        }

        .ai-chat-header {
            background: var(--accent);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .close-ai {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ai-message {
            max-width: 80%;
            padding: 12px 15px;
            border-radius: 15px;
            line-height: 1.4;
        }

        .ai-message-bot {
            background: #f1f3f5;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .ai-message-user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-chat-input {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 25px;
            outline: none;
        }

        .ai-chat-input button {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }

        /* New Styles for Enhanced Features */
        .holiday-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid var(--secondary);
        }
        
        .holiday-info h3 {
            color: var(--secondary);
            margin-bottom: 15px;
        }
        
        .holiday-details {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .holiday-image {
            width: 100%;
            border-radius: 10px;
            object-fit: cover;
            max-height: 200px;
        }
        
        .holiday-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .holiday-content p {
            line-height: 1.6;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .remember-me input {
            width: auto;
        }
        
        .welcome-back {
            text-align: center;
            padding: 10px;
            background: #e6f7ff;
            border-radius: 8px;
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 600;
        }
        input#agreeTerms {
    width: 15px;
    height: 15px;
}

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .calendar-day {
                min-height: 140px;
            }
            
            .profile-container {
                flex-direction: column;
            }
            
            .profile-sidebar {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .calendar-day {
                min-height: 120px;
                padding: 10px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .nav-links {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .calendar-day {
                min-height: 100px;
            }

            .event {
                font-size: 0.7rem;
                padding: 4px 6px;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
        }
    /* Add to your existing CSS */
.system-event {
    border-left: 3px solid #ffd700 !important;
    background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%) !important;
}

.system-badge {
    background: #ffd700;
    color: #333;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7em;
    font-weight: bold;
}

.event.system-event:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}

/* Different colors for different system event types */
.event-national.system-event {
    border-left-color: #dc3545 !important;
    background: linear-gradient(135deg, #ffe6e6 0%, #ffffff 100%) !important;
}

.event-festival.system-event {
    border-left-color: #28a745 !important;
    background: linear-gradient(135deg, #e6ffe6 0%, #ffffff 100%) !important;
}

.event-religious.system-event {
    border-left-color: #6f42c1 !important;
    background: linear-gradient(135deg, #f0e6ff 0%, #ffffff 100%) !important;
}

.event-international.system-event {
    border-left-color: #17a2b8 !important;
    background: linear-gradient(135deg, #e6f7ff 0%, #ffffff 100%) !important;
}
    /* Event Photos Animation Styles */
.event-image-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    margin-bottom: 8px;
}

.event-image {
    width: 100%;
    height: 110px;
    object-fit: cover;
    border-radius: 6px;
    transition: all 0.5s ease;
    cursor: pointer;
}

.event-image:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.event-image.loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loadingShimmer 1.5s infinite;
}

/* Event Description Marquee Animation */
.event-description-marquee {
    position: relative;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 6px;
    padding: 4px 8px;
    margin-top: 4px;
    font-size: 0.7rem;
    color: #555;
    border-left: 3px solid var(--primary);
}

.marquee-content {
    display: inline-block;
    white-space: nowrap;
    padding-left: 100%;
    animation: marquee 15s linear infinite;
    font-style: italic;
}

.marquee-content:hover {
    animation-play-state: paused;
}

/* Multiple events marquee variations */
.event-description-marquee.festival {
    border-left-color: var(--accent);
    background: rgba(156, 39, 176, 0.1);
}

.event-description-marquee.national {
    border-left-color: var(--primary);
    background: rgba(19, 136, 8, 0.1);
}

.event-description-marquee.religious {
    border-left-color: var(--secondary);
    background: rgba(255, 153, 51, 0.1);
}

.event-description-marquee.personal {
    border-left-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
}

/* Event Photo Gallery Animation */
.event-photo-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 4px;
    margin-bottom: 8px;
}

.event-photo-thumbnail {
    width: 100%;
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0;
    animation: fadeInScale 0.5s ease forwards;
}

.event-photo-thumbnail:hover {
    transform: scale(1.1);
    z-index: 2;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Photo counter badge */
.photo-count-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.6rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 2s infinite;
}

/* Event photo modal animation */
.event-photo-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

.event-photo-modal.active {
    display: flex;
}

.modal-photo-container {
    max-width: 90%;
    max-height: 90%;
    position: relative;
    animation: zoomIn 0.4s ease;
}

.modal-event-photo {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

/* Event photo slideshow */
.event-photo-slideshow {
    position: relative;
    height: 100px;
    overflow: hidden;
    border-radius: 8px;
}

.slideshow-container {
    display: flex;
    animation: slideshow 20s infinite;
}

.slideshow-photo {
    min-width: 100%;
    height: 100px;
    object-fit: cover;
}

/* Keyframe Animations */
@keyframes marquee {
    0% {
        transform: translateX(0%);
    }
    100% {
        transform: translateX(-100%);
    }
}

@keyframes loadingShimmer {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

@keyframes fadeInScale {
    0% {
        opacity: 0;
        transform: scale(0.8);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes zoomIn {
    0% {
        opacity: 0;
        transform: scale(0.5);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes slideshow {
    0%, 20% {
        transform: translateX(0%);
    }
    25%, 45% {
        transform: translateX(-100%);
    }
    50%, 70% {
        transform: translateX(-200%);
    }
    75%, 95% {
        transform: translateX(-300%);
    }
    100% {
        transform: translateX(0%);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3);
    }
    50% {
        transform: scale(1.05);
    }
    70% {
        transform: scale(0.9);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes slideInPhoto {
    0% {
        opacity: 0;
        transform: translateY(20px) rotate(-2deg);
    }
    100% {
        opacity: 1;
        transform: translateY(0) rotate(0);
    }
}

/* Enhanced event item with photos */
.event-item-with-photo {
    animation: slideInPhoto 0.6s ease;
    position: relative;
}

.event-item-with-photo::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.event-item-with-photo:hover::before {
    opacity: 1;
}

/* Photo grid animations */
.photo-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    margin: 8px 0;
}

.photo-grid-item {
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 4px;
    animation: bounceIn 0.5s ease;
}

.photo-grid-item:nth-child(1) { animation-delay: 0.1s; }
.photo-grid-item:nth-child(2) { animation-delay: 0.2s; }
.photo-grid-item:nth-child(3) { animation-delay: 0.3s; }

.photo-grid-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.photo-grid-img:hover {
    transform: scale(1.1);
}

/* Event photo upload animation */
.photo-upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.photo-upload-area:hover {
    border-color: var(--primary);
    background: rgba(19, 136, 8, 0.05);
}

.photo-upload-area.dragover {
    border-color: var(--primary);
    background: rgba(19, 136, 8, 0.1);
    animation: pulse 1s infinite;
}

.upload-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: var(--primary);
    width: 0%;
    transition: width 0.3s ease;
}

/* Event photo preview animations */
.photo-preview-container {
    position: relative;
    display: inline-block;
    margin: 5px;
    animation: fadeInScale 0.5s ease;
}

.photo-preview {
    width: 80px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.photo-preview:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.remove-photo {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.photo-preview-container:hover .remove-photo {
    opacity: 1;
}

/* Responsive animations */
@media (max-width: 768px) {
    .event-image {
        height: 60px;
    }
    
    .marquee-content {
        animation-duration: 10s;
    }
    
    .photo-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .event-photo-slideshow {
        height: 80px;
    }
}

@media (max-width: 480px) {
    .event-image {
        height: 50px;
    }
    
    .marquee-content {
        animation-duration: 8s;
        font-size: 0.65rem;
    }
    
    .photo-grid {
        grid-template-columns: 1fr;
    }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    .marquee-content,
    .event-image,
    .photo-grid-item,
    .event-photo-thumbnail,
    .slideshow-container {
        animation: none;
    }
    
    .marquee-content {
        white-space: normal;
        padding-left: 0;
        animation: none;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-calendar-alt"></i> Smart Calendar</h1>
            <div class="tricolor"></div>
            <p class="subtitle">Your Complete Event Management Solution</p>
        </header>

        <nav>
            <div class="nav-links">
                <a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</a>
                <a href="#" class="nav-link" data-page="calendar"><i class="fas fa-calendar"></i> Calendar</a>
                <a href="#" class="nav-link" data-page="events"><i class="fas fa-plus-circle"></i> Add Event</a>
                <a href="#" class="nav-link" data-page="my-events"><i class="fas fa-list"></i> My Events</a>
            </div>
            <div class="user-actions">
                <button class="btn btn-secondary" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login</button>
                <button class="btn btn-primary" id="registerBtn"><i class="fas fa-user-plus"></i> Register</button>
                <div id="userMenu" style="display: none;">
                    <span id="userName"><i class="fas fa-user"></i> Sujan Chandra Ray</span>
                    <button class="btn btn-secondary" id="profileBtn"><i class="fas fa-user-cog"></i> Profile</button>
                    <button class="btn btn-secondary" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </nav>

        <!-- AI Chat Assistant -->
        <div class="ai-assistant">
            <button class="ai-toggle" id="aiToggle">
                <i class="fas fa-robot"></i>
            </button>
            <div class="ai-chat-container" id="aiChatContainer">
                <div class="ai-chat-header">
                    <h3><i class="fas fa-robot"></i> Ana/Anova</h3>
                    <button class="close-ai"><i class="fas fa-times"></i></button>
                </div>
                <div class="ai-chat-messages" id="aiChatMessages">
                    <div class="ai-message ai-message-bot">
                        <p>Hello! I'm your calendar assistant. How can I help you with event planning today?</p>
                    </div>
                </div>
                <div class="ai-chat-input">
                    <input type="text" id="aiChatInput" placeholder="Ask me about events, scheduling, or planning...">
                    <button id="aiSendBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div class="page-content active" id="dashboard-page">
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-calendar-day"></i>
                    <h3 id="totalEvents">3</h3>
                    <p>Total Events</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-bell"></i>
                    <h3 id="upcomingEvents">2</h3>
                    <p>Upcoming Events</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <h3 id="activeUsers">3</h3>
                    <p>Active Users</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-star"></i>
                    <h3 id="festivalsCount">10</h3>
                    <p>Festivals This Month</p>
                </div>
            </div>

            <div class="upcoming-events">
                <h2><i class="fas fa-clock"></i> Upcoming Events</h2>
                <div class="event-list" id="upcomingEventsList">
                    <!-- Upcoming events will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Calendar Page -->
        <div class="page-content" id="calendar-page">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2 id="currentMonth">January 2024</h2>
                    <div class="calendar-nav">
                        <button id="prevMonth"><i class="fas fa-chevron-left"></i> Previous</button>
                        <button id="todayBtn">Today</button>
                        <button id="nextMonth">Next <i class="fas fa-chevron-right"></i></button>
                        <div class="view-options">
                            <button class="view-btn active" data-view="month">Month</button>
                            <button class="view-btn" data-view="week">Week</button>
                            <button class="view-btn" data-view="list">List</button>
                        </div>
                    </div>
                </div>

                <div class="week-days">
                    <div>Sun</div>
                    <div>Mon</div>
                    <div>Tue</div>
                    <div>Wed</div>
                    <div>Thu</div>
                    <div>Fri</div>
                    <div>Sat</div>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar days will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Add Event Page -->
        <div class="page-content" id="events-page">
            <div class="form-container">
                <div class="form-header">
                    <h2><i class="fas fa-plus-circle"></i> Add New Event</h2>
                    <p>Create and manage your events</p>
                </div>
                <form id="eventForm" action="save_event.php" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="eventTitle"><i class="fas fa-heading"></i> Event Title</label>
                        <input type="text" id="eventTitle" name="eventTitle" required placeholder="e.g., Diwali, Republic Day, etc." />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate"><i class="fas fa-calendar-plus"></i> Start Date</label>
                            <input type="date" id="startDate" name="startDate" required />
                        </div>
                        <div class="form-group">
                            <label for="endDate"><i class="fas fa-calendar-minus"></i> End Date</label>
                            <input type="date" id="endDate" name="endDate" required />
                        </div>
                    </div>
                    <!-- In the event modal form, add these time fields after the date fields -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalStartTime">Start Time</label>
                            <input type="time" id="modalStartTime" name="modalStartTime" value="09:00" />
                        </div>
                        <div class="form-group">
                            <label for="modalEndTime">End Time</label>
                            <input type="time" id="modalEndTime" name="modalEndTime" value="17:00" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventCategory"><i class="fas fa-tag"></i> Category</label>
                            <select id="eventCategory" name="eventCategory">
                                <option value="festival">Festival</option>
                                <option value="national">National Holiday</option>
                                <option value="religious">Religious</option>
                                <option value="cultural">Cultural</option>
                                <option value="personal">Personal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="eventPriority"><i class="fas fa-exclamation-circle"></i> Priority</label>
                            <select id="eventPriority" name="eventPriority">
                                <option value="high">High</option>
                                <option value="medium" selected>Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="eventDescription"><i class="fas fa-file-alt"></i> Description</label>
                        <textarea id="eventDescription" name="eventDescription" rows="4" placeholder="Describe the event, traditions, significance..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="eventLocation"><i class="fas fa-map-marker-alt"></i> Location/Celebration</label>
                        <input type="text" id="eventLocation" name="eventLocation" placeholder="e.g., Home, Temple, Nationwide" />
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-camera"></i> Event Photo</label>
                        <div class="photo-upload" onclick="document.getElementById('eventPhoto').click()">
                            <p><i class="fas fa-cloud-upload-alt"></i> Click to upload event photo</p>
                            <small>Recommended: 500x300px or larger</small>
                            <img id="photoPreview" class="photo-preview" alt="Preview" />
                        </div>
                        <input type="file" id="eventPhoto" name="eventPhoto" accept="image/*" style="display: none" onchange="previewPhoto(event)" />
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Event</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- My Events Page -->
        <div class="page-content" id="my-events-page">
            <div class="form-container">
                <div class="form-header">
                    <h2><i class="fas fa-list"></i> My Events</h2>
                    <p>Manage your created events</p>
                </div>
                <div id="userEventsList">
                    <!-- User events will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Login Page -->
        <div class="page-content" id="login-page">
            <div class="form-container">
                <div class="form-header">
                    <h2><i class="fas fa-sign-in-alt"></i> Login to Your Account</h2>
                    <p>Welcome back! Please sign in to your account.</p>
                </div>
                <form id="loginForm" action="login.php" method="POST">
                    <div class="form-group">
                        <label for="loginEmail"><i class="fas fa-envelope"></i> Email Address</label>
                        <input type="email" id="loginEmail" name="loginEmail" required placeholder="Enter your email" />
                    </div>

                    <div class="form-group">
                        <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="loginPassword" name="loginPassword" required placeholder="Enter your password" />
                    </div>

                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe" name="rememberMe" />
                        <label for="rememberMe">Remember me</label>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="backFromLogin">Back</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Login</button>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <p>Don't have an account? <a href="#" id="goToRegister">Register here</a></p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Register Page -->
        <div class="page-content" id="register-page">
            <div class="form-container">
                <div class="form-header">
                    <h2><i class="fas fa-user-plus"></i> Create an Account</h2>
                    <p>Join us to manage your events and calendar</p>
                </div>
                <form id="registerForm" action="register.php" method="POST">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName"><i class="fas fa-user"></i> First Name</label>
                            <input type="text" id="firstName" name="firstName" required placeholder="Enter your first name" />
                        </div>
                        <div class="form-group">
                            <label for="lastName"><i class="fas fa-user"></i> Last Name</label>
                            <input type="text" id="lastName" name="lastName" required placeholder="Enter your last name" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="registerEmail"><i class="fas fa-envelope"></i> Email Address</label>
                        <input type="email" id="registerEmail" name="registerEmail" required placeholder="Enter your email" />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="registerPassword"><i class="fas fa-lock"></i> Password</label>
                            <input type="password" id="registerPassword" name="registerPassword" required placeholder="Create a password" />
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword"><i class="fas fa-lock"></i> Confirm Password</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm your password" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="agreeTerms" name="agreeTerms" required /> I agree to the <a href="#">Terms and Conditions</a>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="backFromRegister">Back</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus"></i> Register</button>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <p>Already have an account? <a href="#" id="goToLogin">Login here</a></p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Profile Page -->
        <div class="page-content" id="profile-page">
            <div class="profile-container">
                <div class="profile-sidebar">
                    <div class="profile-header">
                        <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face" alt="Profile" class="profile-avatar" id="profileAvatar">
                        <div class="profile-info">
                            <h2 id="profileName">Sujan Chandra Ray</h2>
                            <p id="profileEmail">kdfgkjq11@gmail.com</p>
                        </div>
                    </div>
                    <ul class="profile-menu">
                        <li><a href="#" class="profile-menu-link active" data-section="edit-profile"><i class="fas fa-user-edit"></i> Edit Profile</a></li>
                        <li><a href="#" class="profile-menu-link" data-section="change-photo"><i class="fas fa-camera"></i> Change Photo</a></li>
                        <li><a href="#" class="profile-menu-link" data-section="my-events"><i class="fas fa-calendar-check"></i> My Events</a></li>
                        <li><a href="#" class="profile-menu-link" data-section="preferences"><i class="fas fa-cog"></i> Preferences</a></li>
                    </ul>
                </div>
                <div class="profile-content">
                    <!-- Edit Profile Section -->
                    <div class="profile-section active" id="edit-profile-section">
                        <h2><i class="fas fa-user-edit"></i> Edit Profile</h2>
                        <form id="profileForm" action="update_profile.php" method="POST">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="profileFirstName">First Name</label>
                                    <input type="text" id="profileFirstName" name="profileFirstName" value="Sujan Chandra" />
                                </div>
                                <div class="form-group">
                                    <label for="profileLastName">Last Name</label>
                                    <input type="text" id="profileLastName" name="profileLastName" value="Ray" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="profileEmailInput">Email Address</label>
                                <input type="email" id="profileEmailInput" name="profileEmailInput" value="kdfgkjq11@gmail.com" />
                            </div>
                            <div class="form-group">
                                <label for="profilePhone">Phone Number</label>
                                <input type="tel" id="profilePhone" name="profilePhone" value="+91 98765 43210" />
                            </div>
                            <div class="form-group">
                                <label for="profileBio">Bio</label>
                                <textarea id="profileBio" name="profileBio" rows="4">Event enthusiast and calendar organizer</textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
                            </div>
                        </form>
                    </div>

                    <!-- Change Photo Section -->
                    <div class="profile-section" id="change-photo-section">
                        <h2><i class="fas fa-camera"></i> Change Profile Photo</h2>
                        <form id="photoForm" action="update_photo.php" method="POST" enctype="multipart/form-data">
                            <div class="form-group">
                                <div class="photo-upload" onclick="document.getElementById('profilePhotoUpload').click()">
                                    <p><i class="fas fa-cloud-upload-alt"></i> Click to upload profile photo</p>
                                    <small>Recommended: Square image, at least 200x200px</small>
                                    <img id="profilePhotoPreview" class="photo-preview" alt="Preview" />
                                </div>
                                <input type="file" id="profilePhotoUpload" name="profilePhotoUpload" accept="image/*" style="display: none" onchange="previewProfilePhoto(event)" />
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Photo</button>
                            </div>
                        </form>
                    </div>

                    <!-- My Events Section -->
                    <div class="profile-section" id="my-events-section">
                        <h2><i class="fas fa-calendar-check"></i> My Events</h2>
                        <div id="profileEventsList">
                            <!-- User events will be populated here -->
                        </div>
                    </div>

                    <!-- Preferences Section -->
                    <div class="profile-section" id="preferences-section">
                        <h2><i class="fas fa-cog"></i> Preferences</h2>
                        <form id="preferencesForm" action="update_preferences.php" method="POST">
                            <div class="form-group">
                                <label for="notificationPref">Notification Preferences</label>
                                <select id="notificationPref" name="notificationPref">
                                    <option value="all">All Notifications</option>
                                    <option value="important">Important Only</option>
                                    <option value="none">No Notifications</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="timezonePref">Timezone</label>
                                <select id="timezonePref" name="timezonePref">
                                    <option value="ist">India Standard Time (IST)</option>
                                    <option value="est">Eastern Standard Time (EST)</option>
                                    <option value="pst">Pacific Standard Time (PST)</option>
                                    <option value="gmt">Greenwich Mean Time (GMT)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="languagePref">Language</label>
                                <select id="languagePref" name="languagePref">
                                    <option value="en">English</option>
                                    <option value="hi">Hindi</option>
                                    <option value="ta">Tamil</option>
                                    <option value="te">Telugu</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="emailUpdates" name="emailUpdates" checked /> Send me email updates about new features
                                </label>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Preferences</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"><i class="fas fa-calendar-plus"></i> Add Event</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <form id="modalEventForm" action="save_event.php" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="modalSelectedDate" name="modalSelectedDate" />
                <input type="hidden" id="modalEventId" name="modalEventId" />

                <div class="form-group">
                    <label for="modalEventTitle">Event Title</label>
                    <input type="text" id="modalEventTitle" name="modalEventTitle" required placeholder="e.g., Diwali, Republic Day, etc." />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="modalStartDate">Start Date</label>
                        <input type="date" id="modalStartDate" name="modalStartDate" required />
                    </div>
                    <div class="form-group">
                        <label for="modalEndDate">End Date</label>
                        <input type="date" id="modalEndDate" name="modalEndDate" required />
                    </div>
                </div>
                <!-- In the event modal form, add these time fields after the date fields -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalStartTime">Start Time</label>
                            <input type="time" id="modalStartTime" name="modalStartTime" value="09:00" />
                        </div>
                        <div class="form-group">
                            <label for="modalEndTime">End Time</label>
                            <input type="time" id="modalEndTime" name="modalEndTime" value="17:00" />
                        </div>
                    </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="modalEventCategory">Category</label>
                        <select id="modalEventCategory" name="modalEventCategory">
                            <option value="festival">Festival</option>
                            <option value="national">National Holiday</option>
                            <option value="religious">Religious</option>
                            <option value="cultural">Cultural</option>
                            <option value="personal">Personal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modalEventPriority">Priority</label>
                        <select id="modalEventPriority" name="modalEventPriority">
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="modalEventDescription">Description</label>
                    <textarea id="modalEventDescription" name="modalEventDescription" rows="4" placeholder="Describe the event, traditions, significance..."></textarea>
                </div>

                <div class="form-group">
                    <label for="modalEventLocation">Location/Celebration</label>
                    <input type="text" id="modalEventLocation" name="modalEventLocation" placeholder="e.g., Home, Temple, Nationwide" />
                </div>

                <div class="form-group">
                    <label><i class="fas fa-camera"></i> Event Photo</label>
                    <div class="photo-upload" onclick="document.getElementById('modalEventPhoto').click()">
                        <p><i class="fas fa-cloud-upload-alt"></i> Click to upload event photo</p>
                        <small>Recommended: 500x300px or larger</small>
                        <img id="modalPhotoPreview" class="photo-preview" alt="Preview" />
                    </div>
                    <input type="file" id="modalEventPhoto" name="modalEventPhoto" accept="image/*" style="display: none" onchange="previewModalPhoto(event)" />
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="modalCancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailsTitle"><i class="fas fa-info-circle"></i> Event Details</h3>
                <button class="close-modal" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div class="event-details">
                <img id="detailsImage" class="event-image" alt="Event Image" />
                <div class="event-info">
                    <h4>Event Information</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Date</span>
                            <span class="info-value" id="detailsDate"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Category</span>
                            <span class="info-value" id="detailsCategory"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Location</span>
                            <span class="info-value" id="detailsLocation"></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Priority</span>
                            <span class="info-value" id="detailsPriority"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <div id="detailsDescription" style="padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 100px;"></div>
                </div>
                <!-- Holiday Information Section -->
                <div id="holidayInfo" class="holiday-info" style="display: none;">
                    <h3>About this Holiday</h3>
                    <div class="holiday-details">
                        <img id="holidayImage" class="holiday-image" alt="Holiday Image" />
                        <div class="holiday-content">
                            <p id="holidayContent"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
    // Global variable for system events
let systemEvents = [];

// Load system events from database
// Enhanced function to load system events with image fallbacks
async function loadSystemEvents() {
    try {
        const response = await fetch('get_system_events.php');
        const data = await response.json();
        
        if (data.status === 'success') {
            systemEvents = data.events.map(event => ({
                id: 'system_' + event.id,
                title: event.title,
                date: event.start_date,
                endDate: event.end_date,
                startTime: event.start_time || '00:00',
                endTime: event.end_time || '23:59',
                category: event.category,
                priority: event.priority,
                description: event.description,
                location: event.location,
                photo: event.photo || getDefaultEventImage(event.event_type, event.title),
                eventType: event.event_type,
                isSystemEvent: true,
                holidayInfo: {
                    content: event.description,
                    image: event.photo || getDefaultEventImage(event.event_type, event.title)
                }
            }));
            
            console.log("Loaded system events with images:", systemEvents.length);
            refreshAllEventDisplays();
        } else {
            console.error('Failed to load system events:', data.message);
        }
    } catch (error) {
        console.error('Load system events error:', error);
    }
}

// Enhanced function to get default images based on event type and title
function getDefaultEventImage(eventType, title = '') {
    const eventImages = {
        'national': {
            'Republic Day': 'https://images.unsplash.com/photo-1579546929662-711aa81148cf?w=600&h=400&fit=crop',
            'Independence Day': 'https://images.unsplash.com/photo-1594736797933-d0401ba94693?w=600&h=400&fit=crop',
            'Gandhi Jayanti': 'https://images.unsplash.com/photo-1604342050335-8614415a1b4d?w=600&h=400&fit=crop',
            'default': 'https://images.unsplash.com/photo-1579546929662-711aa81148cf?w=600&h=400&fit=crop'
        },
        'festival': {
            'Holi': 'https://images.unsplash.com/photo-1548869207-216df6c2dcc4?w=600&h=400&fit=crop',
            'Diwali': 'https://images.unsplash.com/photo-1604591259957-7e1e7b2d258f?w=600&h=400&fit=crop',
            'Dussehra': 'https://images.unsplash.com/photo-1573459558040-87a81fbaf6cc?w=600&h=400&fit=crop',
            'Durga Puja': 'https://images.unsplash.com/photo-1602524812593-20ffc12189d9?w=600&h=400&fit=crop',
            'Ganesh Chaturthi': 'https://images.unsplash.com/photo-1561135748-4e9c2d6b0c0e?w=600&h=400&fit=crop',
            'default': 'https://images.unsplash.com/photo-1548869207-216df6c2dcc4?w=600&h=400&fit=crop'
        },
        'religious': {
            'Eid al-Fitr': 'https://images.unsplash.com/photo-1563298258-c5eee5a881e2?w=600&h=400&fit=crop',
            'Eid al-Adha': 'https://images.unsplash.com/photo-1596464716127-f2a82984de30?w=600&h=400&fit=crop',
            'Christmas': 'https://images.unsplash.com/photo-1543616991-3b31b5d4c4a5?w=600&h=400&fit=crop',
            'Good Friday': 'https://images.unsplash.com/photo-1459749411175-04bf5292ceea?w=600&h=400&fit=crop',
            'Guru Nanak Jayanti': 'https://images.unsplash.com/photo-1587132135057-a91545fa014f?w=600&h=400&fit=crop',
            'default': 'https://images.unsplash.com/photo-1587132135057-a91545fa014f?w=600&h=400&fit=crop'
        },
        'cultural': {
            'Makar Sankranti': 'https://images.unsplash.com/photo-1543161281-2eafc2b8c47f?w=600&h=400&fit=crop',
            'Pongal': 'https://images.unsplash.com/photo-1577985057584-707d0adc7981?w=600&h=400&fit=crop',
            'Valentine\'s Day': 'https://images.unsplash.com/photo-1518199266807-041125440ab5?w=600&h=400&fit=crop',
            'Mother\'s Day': 'https://images.unsplash.com/photo-1558618666-fcd25856cd63?w=600&h=400&fit=crop',
            'Father\'s Day': 'https://images.unsplash.com/photo-1595435742666-1decd6a5d327?w=600&h=400&fit=crop',
            'default': 'https://images.unsplash.com/photo-1518834107812-67d4c13d805b?w=600&h=400&fit=crop'
        },
        'holiday': {
            'New Year\'s Day': 'https://images.unsplash.com/photo-1579546929662-711aa81148cf?w=600&h=400&fit=crop',
            'International Women\'s Day': 'https://images.unsplash.com/photo-1589571894965-d8256af56c2c?w=600&h=400&fit=crop',
            'Earth Day': 'https://images.unsplash.com/photo-1569163139394-de44cb54d0c8?w=600&h=400&fit=crop',
            'Halloween': 'https://images.unsplash.com/photo-1508361001413-7a89d4d88b3b?w=600&h=400&fit=crop',
            'default': 'https://images.unsplash.com/photo-1543616991-3b31b5d4c4a5?w=600&h=400&fit=crop'
        }
    };

    // Try to get specific image for the event title, then event type, then default
    if (eventImages[eventType] && eventImages[eventType][title]) {
        return eventImages[eventType][title];
    } else if (eventImages[eventType] && eventImages[eventType]['default']) {
        return eventImages[eventType]['default'];
    } else {
        return 'https://images.unsplash.com/photo-1518834107812-67d4c13d805b?w=600&h=400&fit=crop'; // Generic cultural image
    }
}

// Get default holiday image based on event type
function getDefaultHolidayImage(eventType) {
    const defaultImages = {
        'national': 'https://images.unsplash.com/photo-1579546929662-711aa81148cf?w=500&h=300&fit=crop',
        'festival': 'https://images.unsplash.com/photo-1548869207-216df6c2dcc4?w=500&h=300&fit=crop',
        'religious': 'https://images.unsplash.com/photo-1587132135057-a91545fa014f?w=500&h=300&fit=crop',
        'cultural': 'https://images.unsplash.com/photo-1518834107812-67d4c13d805b?w=500&h=300&fit=crop',
        'holiday': 'https://images.unsplash.com/photo-1543616991-3b31b5d4c4a5?w=500&h=300&fit=crop'
    };
    return defaultImages[eventType] || defaultImages.holiday;
}

// Update the getEventsForDate function to include both user events and system events
function getEventsForDate(dateStr) {
    if (!events || events.length === 0) return [];
    
    const currentDate = new Date(dateStr);
    currentDate.setHours(0, 0, 0, 0);
    
    // Combine user events and system events
    const allEvents = [...events, ...systemEvents];
    
    return allEvents.filter(event => {
        if (!event.date) return false;
        
        try {
            const eventStartDate = new Date(event.date);
            eventStartDate.setHours(0, 0, 0, 0);
            
            const eventEndDate = event.endDate ? new Date(event.endDate) : eventStartDate;
            eventEndDate.setHours(0, 0, 0, 0);
            
            return currentDate >= eventStartDate && currentDate <= eventEndDate;
        } catch (error) {
            console.error("Date parsing error:", error);
            return false;
        }
    });
}


// Update this month festivals to include system events
function getThisMonthFestivals() {
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    const allEvents = [...events, ...systemEvents];
    
    return allEvents.filter(event => {
        try {
            const eventDate = new Date(event.date);
            return (event.category === "festival" || event.category === "national" || 
                   event.eventType === "festival" || event.eventType === "national") &&
                   eventDate.getMonth() === currentMonth &&
                   eventDate.getFullYear() === currentYear;
        } catch (error) {
            return false;
        }
    });
}


// Update calendar rendering to show all events
function renderCalendarWithAllEvents() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update current month display
    currentMonthElement.textContent = `${currentDate.toLocaleString("default", { month: "long" })} ${year}`;

    // Clear previous calendar
    calendarGrid.innerHTML = "";

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Create empty cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement("div");
        emptyDay.classList.add("calendar-day", "empty-day");
        emptyDay.innerHTML = '<div class="empty-state"> </div>';
        calendarGrid.appendChild(emptyDay);
    }

    // Create cells for each day of the month
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement("div");
        dayElement.classList.add("calendar-day");

        // Format date for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        // Check if this day is today
        const currentDay = new Date(dateStr);
        currentDay.setHours(0, 0, 0, 0);
        if (currentDay.getTime() === today.getTime()) {
            dayElement.classList.add("today");
        }

        // Get events for this day (both user and system events)
        const dayEvents = getEventsForDate(dateStr);

        // Day header with number and add button
        const dayHeader = document.createElement("div");
        dayHeader.classList.add("day-header");

        const dayNumber = document.createElement("span");
        dayNumber.classList.add("day-number");
        dayNumber.textContent = day;

        const addButton = document.createElement("button");
        addButton.classList.add("add-event-btn");
        addButton.innerHTML = "<i class='fas fa-plus'></i>";
        addButton.title = "Add Event on " + dateStr;
        addButton.addEventListener("click", (e) => {
            e.stopPropagation();
            openAddEventModal(dateStr);
        });

        dayHeader.appendChild(dayNumber);
        dayHeader.appendChild(addButton);
        dayElement.appendChild(dayHeader);

        // Show event count badge if there are events
        if (dayEvents.length > 0) {
            const eventCount = document.createElement("div");
            eventCount.classList.add("event-count");
            eventCount.textContent = dayEvents.length;
            eventCount.title = `${dayEvents.length} events`;
            dayElement.appendChild(eventCount);
        }

        // Events container
        const eventsContainer = document.createElement("div");
        eventsContainer.classList.add("events-container");

        if (dayEvents.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.classList.add("empty-state");
            emptyState.textContent = "No events";
            eventsContainer.appendChild(emptyState);
        } else {
            dayEvents.forEach(event => {
                const eventElement = document.createElement("div");
                const isSystemEvent = event.isSystemEvent || systemEvents.some(se => se.id === event.id);
                
                eventElement.classList.add("event", `event-${event.category || 'personal'}`);
                if (isSystemEvent) {
                    eventElement.classList.add('system-event');
                }
                eventElement.title = `${event.title} - Click for details`;

                const eventIcon = document.createElement("i");
                eventIcon.className = getEventIcon(event.category, isSystemEvent);
                eventIcon.style.marginRight = "5px";

                const eventTitle = document.createElement("span");
                eventTitle.textContent = event.title || "Untitled Event";

                eventElement.appendChild(eventIcon);
                eventElement.appendChild(eventTitle);

                // Add system event badge
                if (isSystemEvent) {
                    const systemBadge = document.createElement("span");
                    systemBadge.classList.add("system-badge");
                    systemBadge.innerHTML = " ";
                    systemBadge.title = "System Event";
                    systemBadge.style.marginLeft = "5px";
                    systemBadge.style.fontSize = "0.7em";
                    eventElement.appendChild(systemBadge);
                }

                // Add click event to view details
                eventElement.addEventListener("click", (e) => {
                    e.stopPropagation();
                    openEventDetails(event);
                });

                eventsContainer.appendChild(eventElement);
            });
        }

        dayElement.appendChild(eventsContainer);
        calendarGrid.appendChild(dayElement);
    }
}

// Update the event details modal to show all event types
function openEventDetails(event) {
    if (!event) {
        showNotification("Event data not available", "error");
        return;
    }

    // Set modal title and content with fallbacks
    document.getElementById("detailsTitle").textContent = event.title || "Untitled Event";
    document.getElementById("detailsDate").textContent = formatEventDate(event);
    document.getElementById("detailsCategory").textContent = (event.category || 'personal').charAt(0).toUpperCase() + (event.category || 'personal').slice(1);
    document.getElementById("detailsLocation").textContent = event.location || "Not specified";
    document.getElementById("detailsPriority").textContent = (event.priority || 'medium').charAt(0).toUpperCase() + (event.priority || 'medium').slice(1);
    document.getElementById("detailsDescription").textContent = event.description || "No description available.";

    // Handle event image
    const detailsImage = document.getElementById("detailsImage");
    if (event.photo) {
        detailsImage.src = event.photo;
        detailsImage.style.display = "block";
    } else {
        detailsImage.style.display = "none";
    }

    // Show holiday information for system events and festivals
    const holidayInfo = document.getElementById("holidayInfo");
    const isSystemEvent = event.isSystemEvent || systemEvents.some(se => se.id === event.id);
    
    if (isSystemEvent || event.category === 'festival' || event.category === 'national') {
        document.getElementById("holidayContent").textContent = event.description || "This is a system event.";
        
        // Use event photo or get default holiday image
        if (event.photo) {
            document.getElementById("holidayImage").src = event.photo;
        } else {
            document.getElementById("holidayImage").src = getDefaultHolidayImage(event.category);
        }
        holidayInfo.style.display = "block";
    } else {
        holidayInfo.style.display = "none";
    }

    detailsModal.style.display = "flex";
}

// Update page navigation to refresh data when switching pages
function showPage(page) {
    // Hide all pages
    document.querySelectorAll(".page-content").forEach(p => {
        p.classList.remove("active");
    });

    // Remove active class from all nav links
    document.querySelectorAll(".nav-link").forEach(link => {
        link.classList.remove("active");
    });

    // Show selected page and set active nav link
    document.getElementById(`${page}-page`).classList.add("active");
    document.querySelector(`.nav-link[data-page="${page}"]`).classList.add("active");

    // Refresh data for specific pages
    if (page === "dashboard") {
        updateDashboard();
    } else if (page === "calendar") {
        renderCalendarWithAllEvents();
    } else if (page === "my-events") {
        loadUserEvents();
    }
}

// Update the initialization to load system events properly
document.addEventListener("DOMContentLoaded", function () {
    // Initialize events with festivals
    events = [...indianFestivals];
    
    // Check login status to set proper UI
    checkLoginStatus();
    
    // Setup other things
    setupEventListeners();
    setupNavigation();
    
    // Load system events for all users
    loadSystemEvents();
    
    // Load user events after login status is checked
    setTimeout(() => {
        if (currentUser) {
            loadEventsFromDatabase();
        } else {
            loadEventsFromLocalStorage();
        }
        renderCalendarWithAllEvents();
        updateDashboard();
    }, 100);
});

// Replace the original functions with updated versions
renderCalendar = renderCalendarWithAllEvents;

console.log("Updated all pages to display both user events and system events");


// Update this month festivals to include system events
function getThisMonthFestivals() {
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    const allEvents = [...events, ...systemEvents];
    
    return allEvents.filter(event => {
        try {
            const eventDate = new Date(event.date);
            return (event.category === "festival" || event.category === "national" || 
                   event.eventType === "festival" || event.eventType === "national") &&
                   eventDate.getMonth() === currentMonth &&
                   eventDate.getFullYear() === currentYear;
        } catch (error) {
            return false;
        }
    });
}

// Update calendar rendering to show all events
function renderCalendarWithAllEvents() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update current month display
    currentMonthElement.textContent = `${currentDate.toLocaleString("default", { month: "long" })} ${year}`;

    // Clear previous calendar
    calendarGrid.innerHTML = "";

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Create empty cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement("div");
        emptyDay.classList.add("calendar-day", "empty-day");
        emptyDay.innerHTML = '<div class="empty-state"> </div>';
        calendarGrid.appendChild(emptyDay);
    }

    // Create cells for each day of the month
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement("div");
        dayElement.classList.add("calendar-day");

        // Format date for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        // Check if this day is today
        const currentDay = new Date(dateStr);
        currentDay.setHours(0, 0, 0, 0);
        if (currentDay.getTime() === today.getTime()) {
            dayElement.classList.add("today");
        }

        // Get events for this day (both user and system events)
        const dayEvents = getEventsForDate(dateStr);

        // Day header with number and add button
        const dayHeader = document.createElement("div");
        dayHeader.classList.add("day-header");

        const dayNumber = document.createElement("span");
        dayNumber.classList.add("day-number");
        dayNumber.textContent = day;

        const addButton = document.createElement("button");
        addButton.classList.add("add-event-btn");
        addButton.innerHTML = "<i class='fas fa-plus'></i>";
        addButton.title = "Add Event on " + dateStr;
        addButton.addEventListener("click", (e) => {
            e.stopPropagation();
            openAddEventModal(dateStr);
        });

        dayHeader.appendChild(dayNumber);
        dayHeader.appendChild(addButton);
        dayElement.appendChild(dayHeader);

        // Show event count badge if there are events
        if (dayEvents.length > 0) {
            const eventCount = document.createElement("div");
            eventCount.classList.add("event-count");
            eventCount.textContent = dayEvents.length;
            eventCount.title = `${dayEvents.length} events`;
            dayElement.appendChild(eventCount);
        }

        // Events container
        const eventsContainer = document.createElement("div");
        eventsContainer.classList.add("events-container");

        if (dayEvents.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.classList.add("empty-state");
            emptyState.textContent = "No events";
            eventsContainer.appendChild(emptyState);
        } else {
            dayEvents.forEach(event => {
                const eventElement = document.createElement("div");
                const isSystemEvent = event.isSystemEvent || systemEvents.some(se => se.id === event.id);
                
                eventElement.classList.add("event", `event-${event.category || 'personal'}`);
                if (isSystemEvent) {
                    eventElement.classList.add('system-event');
                }
                eventElement.title = `${event.title} - Click for details`;

                const eventIcon = document.createElement("i");
                eventIcon.className = getEventIcon(event.category, isSystemEvent);
                eventIcon.style.marginRight = "5px";

                const eventTitle = document.createElement("span");
                eventTitle.textContent = event.title || "Untitled Event";

                eventElement.appendChild(eventIcon);
                eventElement.appendChild(eventTitle);

                // Add system event badge
                if (isSystemEvent) {
                    const systemBadge = document.createElement("span");
                    systemBadge.classList.add("system-badge");
                    systemBadge.innerHTML = " ";
                    systemBadge.title = "System Event";
                    systemBadge.style.marginLeft = "5px";
                    systemBadge.style.fontSize = "0.7em";
                    eventElement.appendChild(systemBadge);
                }

                // Add click event to view details
                eventElement.addEventListener("click", (e) => {
                    e.stopPropagation();
                    openEventDetails(event);
                });

                eventsContainer.appendChild(eventElement);
            });
        }

        dayElement.appendChild(eventsContainer);
        calendarGrid.appendChild(dayElement);
    }
}

// Update the event details modal to show all event types
function openEventDetails(event) {
    if (!event) {
        showNotification("Event data not available", "error");
        return;
    }

    // Set modal title and content with fallbacks
    document.getElementById("detailsTitle").textContent = event.title || "Untitled Event";
    document.getElementById("detailsDate").textContent = formatEventDate(event);
    document.getElementById("detailsCategory").textContent = (event.category || 'personal').charAt(0).toUpperCase() + (event.category || 'personal').slice(1);
    document.getElementById("detailsLocation").textContent = event.location || "Not specified";
    document.getElementById("detailsPriority").textContent = (event.priority || 'medium').charAt(0).toUpperCase() + (event.priority || 'medium').slice(1);
    document.getElementById("detailsDescription").textContent = event.description || "No description available.";

    // Handle event image
    const detailsImage = document.getElementById("detailsImage");
    if (event.photo) {
        detailsImage.src = event.photo;
        detailsImage.style.display = "block";
    } else {
        detailsImage.style.display = "none";
    }

    // Show holiday information for system events and festivals
    const holidayInfo = document.getElementById("holidayInfo");
    const isSystemEvent = event.isSystemEvent || systemEvents.some(se => se.id === event.id);
    
    if (isSystemEvent || event.category === 'festival' || event.category === 'national') {
        document.getElementById("holidayContent").textContent = event.description || "This is a system event.";
        
        // Use event photo or get default holiday image
        if (event.photo) {
            document.getElementById("holidayImage").src = event.photo;
        } else {
            document.getElementById("holidayImage").src = getDefaultHolidayImage(event.category);
        }
        holidayInfo.style.display = "block";
    } else {
        holidayInfo.style.display = "none";
    }

    detailsModal.style.display = "flex";
}


// Update page navigation to refresh data when switching pages
function showPage(page) {
    // Hide all pages
    document.querySelectorAll(".page-content").forEach(p => {
        p.classList.remove("active");
    });

    // Remove active class from all nav links
    document.querySelectorAll(".nav-link").forEach(link => {
        link.classList.remove("active");
    });

    // Show selected page and set active nav link
    document.getElementById(`${page}-page`).classList.add("active");
    document.querySelector(`.nav-link[data-page="${page}"]`).classList.add("active");

    // Refresh data for specific pages
    if (page === "dashboard") {
        updateDashboard();
    } else if (page === "calendar") {
        renderCalendarWithAllEvents();
    } else if (page === "my-events") {
        loadUserEvents();
    }
}

// Update the initialization to properly load all events
document.addEventListener("DOMContentLoaded", function () {
    // Initialize with empty events array
    events = [];
    userEvents = [];
    systemEvents = [];
    
    // FIRST: Check login status
    checkLoginStatus();
    
    // SECOND: Setup event listeners and navigation
    setupEventListeners();
    setupNavigation();
    
    // THIRD: Load ALL events in proper order
    loadAllEvents();
});

// Function to load all events in proper sequence
function loadAllEvents() {
    console.log(" Loading all events...");
    
    // Step 1: Load system events first
    loadSystemEvents().then(() => {
        console.log(" System events loaded:", systemEvents.length);
        
        // Step 2: Load user events based on login status
        if (currentUser) {
            loadEventsFromDatabase().then(() => {
                console.log(" User events loaded from database:", userEvents.length);
                completeInitialization();
            }).catch(error => {
                console.error(" Database load failed, using localStorage:", error);
                loadEventsFromLocalStorage();
                completeInitialization();
            });
        } else {
            loadEventsFromLocalStorage();
            console.log(" User events loaded from localStorage:", userEvents.length);
            completeInitialization();
        }
    }).catch(error => {
        console.error(" System events load failed:", error);
        // Continue with initialization even if system events fail
        if (currentUser) {
            loadEventsFromDatabase().then(completeInitialization);
        } else {
            loadEventsFromLocalStorage();
            completeInitialization();
        }
    });
}

function completeInitialization() {
    // Combine all events
    events = [...systemEvents, ...userEvents];
    console.log(" All events combined:", events.length);
    console.log("System events:", systemEvents.length);
    console.log("User events:", userEvents.length);
    
    // Update ALL UI components
    refreshAllEventDisplays();
    
    // Show dashboard by default
    showDashboard();
}

// Enhanced system events loading with Promise
function loadSystemEvents() {
    return new Promise((resolve, reject) => {
        try {
            // Use the pre-defined indianFestivals array as system events
            systemEvents = indianFestivals.map(event => ({
                ...event,
                isSystemEvent: true,
                eventType: event.category || 'festival'
            }));
            
            console.log(" System events initialized:", systemEvents.length);
            resolve(systemEvents);
        } catch (error) {
            console.error("Error loading system events:", error);
            reject(error);
        }
    });
}

// Enhanced function to get events for a specific date
function getEventsForDate(dateStr) {
    if (!events || events.length === 0) {
        console.log("No events available for date:", dateStr);
        return [];
    }
    
    const currentDate = new Date(dateStr);
    currentDate.setHours(0, 0, 0, 0);
    
    const dayEvents = events.filter(event => {
        if (!event.date) return false;
        
        try {
            const eventStartDate = new Date(event.date);
            eventStartDate.setHours(0, 0, 0, 0);
            
            const eventEndDate = event.endDate ? new Date(event.endDate) : eventStartDate;
            eventEndDate.setHours(0, 0, 0, 0);
            
            const isInRange = currentDate >= eventStartDate && currentDate <= eventEndDate;
            
            if (isInRange) {
                console.log(` Event found for ${dateStr}:`, event.title);
            }
            
            return isInRange;
        } catch (error) {
            console.error("Date parsing error for event:", event, error);
            return false;
        }
    });
    
    console.log(` Found ${dayEvents.length} events for ${dateStr}`);
    return dayEvents;
}

// Update ALL display functions


function getThisMonthFestivals() {
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    
    return events.filter(event => {
        try {
            const eventDate = new Date(event.date);
            return (event.category === "festival" || event.category === "national" || 
                   event.eventType === "festival" || event.eventType === "national") &&
                   eventDate.getMonth() === currentMonth &&
                   eventDate.getFullYear() === currentYear;
        } catch (error) {
            return false;
        }
    });
}


// 2. CALENDAR - Show all events
function renderCalendar() {
    console.log(" Rendering calendar for:", currentDate.toLocaleString('default', { month: 'long', year: 'numeric' }));
    
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update current month display
    currentMonthElement.textContent = `${currentDate.toLocaleString("default", { month: "long" })} ${year}`;

    // Clear previous calendar
    calendarGrid.innerHTML = "";

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Create empty cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement("div");
        emptyDay.classList.add("calendar-day", "empty-day");
        emptyDay.innerHTML = '<div class="empty-state"> </div>';
        calendarGrid.appendChild(emptyDay);
    }

    // Create cells for each day of the month
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement("div");
        dayElement.classList.add("calendar-day");

        // Format date for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        // Check if this day is today
        const currentDay = new Date(dateStr);
        currentDay.setHours(0, 0, 0, 0);
        if (currentDay.getTime() === today.getTime()) {
            dayElement.classList.add("today");
        }

        // Get events for this day
        const dayEvents = getEventsForDate(dateStr);

        // Day header with number and add button
        const dayHeader = document.createElement("div");
        dayHeader.classList.add("day-header");

        const dayNumber = document.createElement("span");
        dayNumber.classList.add("day-number");
        dayNumber.textContent = day;

        const addButton = document.createElement("button");
        addButton.classList.add("add-event-btn");
        addButton.innerHTML = "<i class='fas fa-plus'></i>";
        addButton.title = "Add Event on " + dateStr;
        addButton.addEventListener("click", (e) => {
            e.stopPropagation();
            openAddEventModal(dateStr);
        });

        dayHeader.appendChild(dayNumber);
        dayHeader.appendChild(addButton);
        dayElement.appendChild(dayHeader);

        // Show event count badge if there are events
        if (dayEvents.length > 0) {
            const eventCount = document.createElement("div");
            eventCount.classList.add("event-count");
            eventCount.textContent = dayEvents.length;
            eventCount.title = `${dayEvents.length} events`;
            dayElement.appendChild(eventCount);
        }

        // Events container
        const eventsContainer = document.createElement("div");
        eventsContainer.classList.add("events-container");

        if (dayEvents.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.classList.add("empty-state");
            emptyState.textContent = "No events";
            eventsContainer.appendChild(emptyState);
        } else {
            dayEvents.forEach(event => {
                const eventElement = document.createElement("div");
                const isSystemEvent = event.isSystemEvent;
                
                eventElement.classList.add("event", `event-${event.category || 'personal'}`);
                if (isSystemEvent) {
                    eventElement.classList.add('system-event');
                }
                eventElement.title = `${event.title} - Click for details`;
                eventElement.style.cursor = "pointer";

                const eventIcon = document.createElement("i");
                eventIcon.className = getEventIcon(event.category, isSystemEvent);
                eventIcon.style.marginRight = "5px";

                const eventTitle = document.createElement("span");
                eventTitle.textContent = event.title || "Untitled Event";

                eventElement.appendChild(eventIcon);
                eventElement.appendChild(eventTitle);

                // Add system event badge
                if (isSystemEvent) {
                    const systemBadge = document.createElement("span");
                    systemBadge.classList.add("system-badge");
                    systemBadge.innerHTML = " ";
                    systemBadge.title = "System Event";
                    systemBadge.style.marginLeft = "5px";
                    systemBadge.style.fontSize = "0.7em";
                    eventElement.appendChild(systemBadge);
                }

                // Add click event to view details
                eventElement.addEventListener("click", (e) => {
                    e.stopPropagation();
                    openEventDetails(event);
                });

                eventsContainer.appendChild(eventElement);
            });
        }

        dayElement.appendChild(eventsContainer);
        calendarGrid.appendChild(dayElement);
    }
    
    console.log(" Calendar rendered for", daysInMonth, "days");
}

// 3. ADD EVENT - Keep existing functionality but ensure it updates all displays
function saveEvent(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        showLoginPage();
        return;
    }

    const eventData = {
        eventTitle: document.getElementById("eventTitle").value.trim(),
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        startTime: document.getElementById("modalStartTime").value || "09:00",
        endTime: document.getElementById("modalEndTime").value || "17:00",
        eventCategory: document.getElementById("eventCategory").value,
        eventPriority: document.getElementById("eventPriority").value,
        eventDescription: document.getElementById("eventDescription").value.trim(),
        eventLocation: document.getElementById("eventLocation").value.trim(),
        userId: currentUser.id
    };

    // Validation
    if (!eventData.eventTitle) {
        showNotification("Event title is required", "error");
        return;
    }

    const saveBtn = document.querySelector('#eventForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    // Simulate save (replace with actual API call)
    setTimeout(() => {
        const newEvent = {
            id: Date.now(),
            title: eventData.eventTitle,
            date: eventData.startDate,
            endDate: eventData.endDate,
            startTime: eventData.startTime,
            endTime: eventData.endTime,
            category: eventData.eventCategory,
            priority: eventData.eventPriority,
            description: eventData.eventDescription,
            location: eventData.eventLocation,
            userId: currentUser.id,
            isSystemEvent: false
        };

        // Add to user events
        userEvents.push(newEvent);
        
        // Update combined events
        events = [...systemEvents, ...userEvents];
        
        // Save to storage
        saveEventsToStorage();
        
        // Update ALL displays
        refreshAllEventDisplays();
        
        // Reset form
        document.getElementById("eventForm").reset();
        document.getElementById("photoPreview").style.display = "none";

        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;

        showNotification("Event saved successfully!", "success");
        
        // Auto-switch to My Events page
        setTimeout(() => {
            showPage("my-events");
        }, 1000);
    }, 1000);
}

// 4. MY EVENTS - Show only user events (keep existing)
function loadUserEvents() {
    const userEventsList = document.getElementById("userEventsList");
    if (!userEventsList) return;
    
    userEventsList.innerHTML = "";
    
    if (!currentUser) {
        userEventsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                Please log in to view your events
            </div>
        `;
        return;
    }
    
    const userSpecificEvents = userEvents.filter(event => 
        event.userId === currentUser.id
    );
    
    if (userSpecificEvents.length === 0) {
        userEventsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-plus"></i>
                You haven't created any events yet. 
                <br><small>Click "Add Event" to create your first event!</small>
            </div>
        `;
        return;
    }
    
    // Sort events by date (newest first)
    const sortedEvents = userSpecificEvents.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA;
    });
    
    sortedEvents.forEach(event => {
        const eventElement = document.createElement("div");
        eventElement.classList.add("event-item");
        
        // Format date
        let formattedDate = "Date not set";
        let day = "?";
        let month = "???";
        
        try {
            const eventDate = new Date(event.date);
            if (!isNaN(eventDate.getTime())) {
                formattedDate = eventDate.toLocaleDateString("en-US", {
                    weekday: "short",
                    year: "numeric",
                    month: "short",
                    day: "numeric"
                });
                day = eventDate.getDate();
                month = eventDate.toLocaleString('default', { month: 'short' });
            }
        } catch (error) {
            console.error("Date formatting error:", error);
        }
        
        const startTime = event.startTime ? formatTime(event.startTime) : 'All Day';
        const endTime = event.endTime ? formatTime(event.endTime) : '';
        const timeDisplay = endTime ? `${startTime} - ${endTime}` : startTime;
        
        eventElement.innerHTML = `
            <div class="event-date">
                <div class="day">${day}</div>
                <div class="month">${month}</div>
            </div>
            <div class="event-details">
                <h4>${event.title || "Untitled Event"}</h4>
                <p><i class="fas fa-calendar"></i> ${formattedDate}</p>
                <p><i class="fas fa-clock"></i> ${timeDisplay}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${event.location || 'No location specified'}</p>
                <small>${event.description || 'No description provided'}</small>
            </div>
            <div class="event-category ${event.category}">
                ${event.category.charAt(0).toUpperCase() + event.category.slice(1)}
            </div>
            <button class="btn btn-danger btn-sm" onclick="deleteEvent(${event.id})" title="Delete Event">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        userEventsList.appendChild(eventElement);
    });
}

// Update page navigation to refresh data
function showPage(page) {
    console.log(" Switching to page:", page);
    
    // Hide all pages
    document.querySelectorAll(".page-content").forEach(p => {
        p.classList.remove("active");
    });

    // Remove active class from all nav links
    document.querySelectorAll(".nav-link").forEach(link => {
        link.classList.remove("active");
    });

    // Show selected page and set active nav link
    const pageElement = document.getElementById(`${page}-page`);
    const navLink = document.querySelector(`.nav-link[data-page="${page}"]`);
    
    if (pageElement && navLink) {
        pageElement.classList.add("active");
        navLink.classList.add("active");
        
        // Refresh data for specific pages
        switch(page) {
            case "dashboard":
                updateDashboard();
                break;
            case "calendar":
                renderCalendar();
                break;
            case "my-events":
                loadUserEvents();
                break;
            case "events":
                // Add Event page - no special refresh needed
                break;
        }
        
        console.log(" Page switched to:", page);
    } else {
        console.error(" Page element not found:", page);
    }
}


// Force refresh all data (useful for debugging)
function forceRefreshAllData() {
    console.log(" Force refreshing all data...");
    events = [...systemEvents, ...userEvents];
    refreshAllEventDisplays();
}

// Add this to debug current state
function debugEvents() {
    console.log("=== DEBUG EVENTS ===");
    console.log("Total events:", events.length);
    console.log("System events:", systemEvents.length);
    console.log("User events:", userEvents.length);
    console.log("Current user:", currentUser);
    console.log("Is logged in:", isLoggedIn);
    console.log("====================");
}

// Call this to see current state
// debugEvents();
// Replace the original functions with updated versions
renderCalendar = renderCalendarWithAllEvents;

console.log("Updated all pages to display both user events and system events");
// Update event display to distinguish system events
function getEventIcon(category, isSystemEvent = false) {
    if (isSystemEvent) {
        switch(category) {
            case 'national': return 'fas fa-flag';
            case 'festival': return 'fas fa-gifts';
            case 'religious': return 'fas fa-pray';
            case 'cultural': return 'fas fa-music';
            case 'holiday': return 'fas fa-umbrella-beach';
            default: return 'fas fa-calendar-star';
        }
    } else {
        switch(category) {
            case 'festival': return 'fas fa-gifts';
            case 'national': return 'fas fa-flag';
            case 'religious': return 'fas fa-pray';
            case 'cultural': return 'fas fa-music';
            case 'personal': return 'fas fa-user';
            default: return 'fas fa-calendar';
        }
    }
}
// In your renderCalendar function, update the event creation part:
function renderCalendar() {
    // ... existing code ...
    
    // Inside the day creation loop, update event creation:
    if (dayEvents.length === 0) {
        const emptyState = document.createElement("div");
        emptyState.classList.add("empty-state");
        emptyState.textContent = " ";
        eventsContainer.appendChild(emptyState);
    } else {
        dayEvents.forEach(event => {
            const eventElement = document.createElement("div");
            const isSystemEvent = event.isSystemEvent;
            
            eventElement.classList.add("event", `event-${event.category || 'personal'}`);
            if (isSystemEvent) {
                eventElement.classList.add('system-event');
            }
            eventElement.title = `${event.title} - Click for details`;

            const eventIcon = document.createElement("i");
            eventIcon.className = getEventIcon(event.category, isSystemEvent);
            eventIcon.style.marginRight = "5px";

            const eventTitle = document.createElement("span");
            eventTitle.textContent = event.title || "Untitled Event";

            eventElement.appendChild(eventIcon);
            eventElement.appendChild(eventTitle);

            // Add system event badge
            if (isSystemEvent) {
                const systemBadge = document.createElement("span");
                systemBadge.classList.add("system-badge");
                systemBadge.innerHTML = "";
                systemBadge.title = "System Event";
                systemBadge.style.marginLeft = "5px";
                systemBadge.style.fontSize = "0.7em";
                eventElement.appendChild(systemBadge);
            }

            // Add click event to view details
            eventElement.addEventListener("click", (e) => {
                e.stopPropagation();
                openEventDetails(event);
            });

            eventsContainer.appendChild(eventElement);
        });
    }
    
    // ... rest of the function ...
}
</script>
    <script>
    // Global variables
    let events = [];
    let userEvents = [];
    let currentDate = new Date();
    let selectedDate = "";
    let editingEventId = null;
    let isLoggedIn = false;
    let currentUser = null;

    // Simulated database for users (using localStorage for demo)
    const usersDatabase = [
        {
            id: 1,
            firstName: "Sujan Chandra",
            lastName: "Ray",
            email: "kdfgkjq11@gmail.com",
            password: "password123",
            phone: "+91 98765 43210",
            bio: "Event enthusiast and calendar organizer",
            profile_picture: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face",
            preferences: {
                notifications: "all",
                timezone: "ist",
                language: "en",
                emailUpdates: true
            }
        },
        {
            id: 2,
            firstName: "John",
            lastName: "Doe",
            email: "john@example.com",
            password: "password123",
            phone: "+91 98765 43211",
            bio: "Calendar user",
            profile_picture: "",
            preferences: {
                notifications: "important",
                timezone: "ist",
                language: "en",
                emailUpdates: false
            }
        }
    ];

    // Enhanced Indian Festivals and Events Data with detailed information
    const indianFestivals = [];

let id = 1;

// Generate combined Indian and World festivals for 2024-2050
for (let year = 2024; year <= 2050; year++) {
    // Fixed date festivals array - COMBINED INDIAN & WORLD
    const allFestivals = [
        // ========== INDIAN NATIONAL HOLIDAYS ==========
        { title: "Republic Day", date: `${year}-01-26`, category: "national", priority: "high", description: "Celebration of the Constitution of India. Grand parade at Kartavya Path, New Delhi.", location: "Nationwide, main event in New Delhi", photo: "https://t4.ftcdn.net/jpg/04/01/34/91/360_F_401349131_5mUZ0bRDhjS5OQv42gNW7cVWGkpoOJ0K.jpg" },
        { title: "Independence Day", date: `${year}-08-15`, category: "national", priority: "high", description: "Celebration of India's independence from British rule.", location: "Nationwide, main event in New Delhi", photo: "https://jupiteracademy.org/wp-content/uploads/2024/08/6f6bd7c507787ba345396d2cd090c181.jpg" },
        { title: "Gandhi Jayanti", date: `${year}-10-02`, category: "national", priority: "high", description: "Birth anniversary of Mahatma Gandhi, Father of the Nation.", location: "Nationwide", photo: "https://images.unsplash.com/photo-1603889330166-5b1547ccf8c3?w=500&h=300&fit=crop" },
        
        // ========== INDIAN RELIGIOUS FESTIVALS ==========
        { title: "Makar Sankranti", date: `${year}-01-14`, category: "religious", priority: "medium", description: "Harvest festival celebrating sun's northward journey", location: "Nationwide", photo: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=500&h=300&fit=crop" },
        { title: "Vasant Panchami", date: `${year}-01-29`, category: "religious", priority: "medium", description: "Festival dedicated to Goddess Saraswati", location: "Nationwide", photo: "https://images.unsplash.com/photo-1580476265270-9d4a1905d2b4?w=500&h=300&fit=crop" },
        { title: "Maha Shivratri", date: `${year}-03-08`, category: "religious", priority: "medium", description: "Great night of Lord Shiva", location: "Nationwide", photo: "https://images.unsplash.com/photo-1580476265270-9d4a1905d2b2?w=500&h=300&fit=crop" },
        { title: "Ram Navami", date: `${year}-04-17`, category: "religious", priority: "medium", description: "Birth anniversary of Lord Rama", location: "Nationwide", photo: "https://images.unsplash.com/photo-1631661455545-6ccda71bf56a?w=500&h=300&fit=crop" },
        { title: "Raksha Bandhan", date: `${year}-08-19`, category: "religious", priority: "medium", description: "Celebrating bond between brothers and sisters", location: "Nationwide", photo: "https://images.unsplash.com/photo-1596464716127-f2a82984de30?w=500&h=300&fit=crop" },
        { title: "Janmashtami", date: `${year}-08-26`, category: "religious", priority: "high", description: "Birth anniversary of Lord Krishna", location: "Nationwide", photo: "https://images.unsplash.com/photo-1596464716127-f2a82984de31?w=500&h=300&fit=crop" },
        { title: "Ganesh Chaturthi", date: `${year}-09-07`, category: "religious", priority: "high", description: "Celebration of Lord Ganesha's birth", location: "Nationwide", photo: "https://images.unsplash.com/photo-1596464716127-f2a82984de32?w=500&h=300&fit=crop" },
        { title: "Guru Nanak Jayanti", date: `${year}-11-15`, category: "religious", priority: "medium", description: "Birth anniversary of Guru Nanak Dev Ji", location: "Nationwide", photo: "https://media.assettype.com/theceo%2F2023-09%2F77b39296-b5d3-413e-8765-0b00c48425f5%2FTCM___Guru_Nanak_Jayanti.jpg" },
        
        // ========== INDIAN CULTURAL EVENTS ==========
        { title: "Republic Day Parade", date: `${year}-01-26`, category: "cultural", priority: "high", description: "Grand military and cultural parade in New Delhi", location: "New Delhi", photo: "https://images.unsplash.com/photo-1579546929662-711aa81148cf?w=500&h=300&fit=crop" },
        { title: "Beating Retreat Ceremony", date: `${year}-01-29`, category: "cultural", priority: "medium", description: "Ceremony marking the end of Republic Day celebrations", location: "New Delhi", photo: "https://images.unsplash.com/photo-1579546929662-711aa81148c0?w=500&h=300&fit=crop" },
        { title: "Teacher's Day", date: `${year}-09-05`, category: "cultural", priority: "low", description: "Honoring teachers and their contributions", location: "India", photo: "https://images.unsplash.com/photo-1584697964358-3e14ca57658b?w=500&h=300&fit=crop" },
        { title: "Children's Day", date: `${year}-11-14`, category: "cultural", priority: "low", description: "Celebrating childhood and children", location: "India", photo: "https://universepublicschool.org/wp-content/uploads/2024/11/World-Childrens-Day-Banner-750x350.jpg" },
        
        // ========== INTERNATIONAL HOLIDAYS ==========
        { title: "New Year's Day", date: `${year}-01-01`, category: "international", priority: "high", description: "Celebration of the new year", location: "Worldwide", photo: "https://images.unsplash.com/photo-1572883454114-5c0033c8c394?w=500&h=300&fit=crop" },
        { title: "Valentine's Day", date: `${year}-02-14`, category: "cultural", priority: "medium", description: "Celebration of love and romance", location: "Worldwide", photo: "https://elements-resized.envatousercontent.com/elements-video-cover-images/02357079-a767-4b43-887a-ef9080438fd2/video_preview/video_preview_0000.jpg?w=500&cf_fit=cover&q=85&format=auto&s=01ca73489345f1cf99a0afe5eca27bc245c2633449082955a2a14dcf84de80e3" },
        { title: "International Women's Day", date: `${year}-03-08`, category: "international", priority: "medium", description: "Celebrating women's achievements and rights", location: "Worldwide", photo: "https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=500&h=300&fit=crop" },
        { title: "April Fools' Day", date: `${year}-04-01`, category: "cultural", priority: "low", description: "Day for playing practical jokes", location: "Worldwide", photo: "https://images.unsplash.com/photo-1612170153139-6f881ff067b0?w=500&h=300&fit=crop" },
        { title: "Labour Day", date: `${year}-05-01`, category: "international", priority: "medium", description: "Celebrating workers' rights and achievements", location: "Worldwide", photo: "https://images.unsplash.com/photo-1507676184212-d03ab07a01bf?w=500&h=300&fit=crop" },
        { title: "Halloween", date: `${year}-10-31`, category: "cultural", priority: "medium", description: "Celebration with costumes and trick-or-treating", location: "Worldwide", photo: "https://images.unsplash.com/photo-1508361001413-7a9dca21d08a?w=500&h=300&fit=crop" },
        { title: "Christmas Day", date: `${year}-12-25`, category: "international", priority: "high", description: "Celebration of the birth of Jesus Christ", location: "Worldwide", photo: "https://www.shutterstock.com/image-vector/christmas-day-typography-tshirt-design-600nw-2489488135.jpg" },
        { title: "Boxing Day", date: `${year}-12-26`, category: "international", priority: "medium", description: "Traditional gift-giving day after Christmas", location: "Commonwealth countries", photo: "https://images.unsplash.com/photo-1574359411659-619d6d7702d1?w=500&h=300&fit=crop" },
        
        // ========== USA HOLIDAYS ==========
        { title: "Martin Luther King Jr. Day", date: `${year}-01-15`, category: "national", priority: "medium", description: "Honoring civil rights leader Martin Luther King Jr.", location: "United States", photo: "https://images.unsplash.com/photo-1611264329912-8a5aeb6b7a94?w=500&h=300&fit=crop" },
        { title: "President's Day", date: `${year}-02-19`, category: "national", priority: "medium", description: "Honoring all US presidents", location: "United States", photo: "https://images.unsplash.com/photo-1580130775567-2498f16ed4d1?w=500&h=300&fit=crop" },
        { title: "Memorial Day", date: `${year}-05-27`, category: "national", priority: "high", description: "Honoring military personnel who died in service", location: "United States", photo: "https://images.unsplash.com/photo-1531058020387-3be344556be6?w=500&h=300&fit=crop" },
        { title: "Independence Day (USA)", date: `${year}-07-04`, category: "national", priority: "high", description: "Celebration of American independence", location: "United States", photo: "https://images.unsplash.com/photo-1464207687429-7505649dae38?w=500&h=300&fit=crop" },
        { title: "Labor Day (USA)", date: `${year}-09-02`, category: "national", priority: "medium", description: "Celebrating American workers", location: "United States", photo: "https://images.unsplash.com/photo-1551135040-4b1f3b5b5b0a?w=500&h=300&fit=crop" },
        { title: "Thanksgiving", date: `${year}-11-28`, category: "national", priority: "high", description: "Harvest festival and family gathering", location: "United States, Canada", photo: "https://static.vecteezy.com/system/resources/previews/004/105/311/non_2x/happy-thanksgiving-poster-with-pumpkins-and-maple-leaves-greeting-card-for-the-thanksgiving-day-vector.jpg" },
        { title: "Veterans Day", date: `${year}-11-11`, category: "national", priority: "medium", description: "Honoring military veterans", location: "United States", photo: "https://news.va.gov/wp-content/uploads/sites/3/2023/10/Veterans-Day-GettyImages-1423034736_vp1.jpg?w=1400" },
        
        // ========== EUROPEAN HOLIDAYS ==========
        { title: "Bastille Day", date: `${year}-07-14`, category: "national", priority: "high", description: "French National Day celebrating the French Revolution", location: "France", photo: "https://images.unsplash.com/photo-1502602898536-47ad22581b52?w=500&h=300&fit=crop" },
        { title: "Canada Day", date: `${year}-07-01`, category: "national", priority: "high", description: "Celebration of Canadian Confederation", location: "Canada", photo: "https://images.unsplash.com/photo-1519832979-6fa011b87667?w=500&h=300&fit=crop" },
        { title: "Australia Day", date: `${year}-01-26`, category: "national", priority: "high", description: "National day of Australia", location: "Australia", photo: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=500&h=300&fit=crop" },
        { title: "ANZAC Day", date: `${year}-04-25`, category: "national", priority: "high", description: "Remembering military personnel from Australia and New Zealand", location: "Australia, New Zealand", photo: "https://images.unsplash.com/photo-1546260359-22a7b53d43d8?w=500&h=300&fit=crop" },
        
        // ========== ASIAN HOLIDAYS ==========
        { title: "Chinese New Year", date: `${year}-01-25`, category: "cultural", priority: "high", description: "Lunar New Year celebration", location: "China, Worldwide", photo: "https://images.unsplash.com/photo-1547592188-83508c2d5e16?w=500&h=300&fit=crop" },
        { title: "National Day (China)", date: `${year}-10-01`, category: "national", priority: "high", description: "Celebrating the founding of People's Republic of China", location: "China", photo: "https://images.unsplash.com/photo-1508804185872-d7badad00f7d?w=500&h=300&fit=crop" },
        { title: "Chuseok", date: `${year}-09-15`, category: "cultural", priority: "high", description: "Korean harvest festival", location: "South Korea", photo: "https://images.unsplash.com/photo-1565348883025-4f96d7f169b1?w=500&h=300&fit=crop" },
        
        // ========== MIDDLE EASTERN HOLIDAYS ==========
        { title: "Nowruz", date: `${year}-03-21`, category: "cultural", priority: "high", description: "Persian New Year celebrating spring", location: "Iran, Central Asia", photo: "https://images.unsplash.com/photo-1643318378425-8560b7c6d0e9?w=500&h=300&fit=crop" },
        
        // ========== UN INTERNATIONAL DAYS ==========
        { title: "World Health Day", date: `${year}-04-07`, category: "international", priority: "low", description: "Global health awareness day", location: "Worldwide", photo: "https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=500&h=300&fit=crop" },
        { title: "Earth Day", date: `${year}-04-22`, category: "international", priority: "medium", description: "Support for environmental protection", location: "Worldwide", photo: "https://images.unsplash.com/photo-1569163139394-de44cb2c8cb8?w=500&h=300&fit=crop" },
        { title: "International Yoga Day", date: `${year}-06-21`, category: "international", priority: "medium", description: "Celebration of yoga and its benefits", location: "Worldwide", photo: "https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?w=500&h=300&fit=crop" },
        { title: "International Peace Day", date: `${year}-09-21`, category: "international", priority: "medium", description: "Devoted to strengthening peace ideals", location: "Worldwide", photo: "https://images.unsplash.com/photo-1507838153414-b4b71375a4b5?w=500&h=300&fit=crop" },
        { title: "Human Rights Day", date: `${year}-12-10`, category: "international", priority: "medium", description: "Commemorating the Universal Declaration of Human Rights", location: "Worldwide", photo: "https://swikblog.com/wp-content/uploads/2019/11/Capture-human-rights.jpg" }
    ];

    // Add fixed date festivals
    allFestivals.forEach(festival => {
        indianFestivals.push({
            id: id++,
            title: festival.title,
            date: festival.date,
            endDate: festival.date,
            category: festival.category,
            priority: festival.priority,
            description: festival.description,
            location: festival.location,
            photo: festival.photo
        });
    });

    // ========== MOVING FESTIVALS CALCULATION ==========
    // Indian moving festivals
    const holiDate = new Date(year, 2, 25 - ((year - 2024) % 3));
    const diwaliDate = new Date(year, 9, 23 + ((year - 2024) % 15));
    const dussehraDate = new Date(diwaliDate);
    dussehraDate.setDate(diwaliDate.getDate() - 20);

    // International moving festivals
    const easterDate = new Date(year, 2, 31 - ((year - 2024) % 7));
    const goodFridayDate = new Date(easterDate);
    goodFridayDate.setDate(easterDate.getDate() - 2);
    
    const ramadanStart = new Date(year, 2, 22 + ((year - 2024) % 11));
    const eidFitrDate = new Date(ramadanStart);
    eidFitrDate.setDate(ramadanStart.getDate() + 29);
    
    const eidAdhaDate = new Date(eidFitrDate);
    eidAdhaDate.setDate(eidFitrDate.getDate() + 70);

    const movingFestivals = [
        // Indian moving festivals
        { title: "Holi", date: holiDate, category: "religious", priority: "high", description: "Festival of colors celebrating victory of good over evil", location: "Nationwide", photo: "https://images.unsplash.com/photo-1548869207-216df6c2dcc4?w=500&h=300&fit=crop" },
        { title: "Diwali", date: diwaliDate, category: "religious", priority: "high", description: "Festival of lights celebrating victory of light over darkness", location: "Nationwide", photo: "https://images.unsplash.com/photo-1604608944430-952bdc0d4ce5?w=500&h=300&fit=crop" },
        { title: "Dussehra", date: dussehraDate, category: "religious", priority: "high", description: "Victory of Lord Rama over Ravana", location: "Nationwide", photo: "https://images.unsplash.com/photo-1601992688411-1dc47113e275?w=500&h=300&fit=crop" },
        
        // International moving festivals
        { title: "Good Friday", date: goodFridayDate, category: "religious", priority: "high", description: "Commemoration of crucifixion of Jesus Christ", location: "Christian countries", photo: "https://images.unsplash.com/photo-1511300636408-a63a89df3482?w=500&h=300&fit=crop" },
        { title: "Easter Sunday", date: easterDate, category: "religious", priority: "high", description: "Celebration of resurrection of Jesus Christ", location: "Christian countries", photo: "https://images.unsplash.com/photo-1551276521-072b0b9b399f?w=500&h=300&fit=crop" },
        { title: "Ramadan Starts", date: ramadanStart, category: "religious", priority: "high", description: "Beginning of Islamic holy month of fasting", location: "Muslim countries", photo: "https://images.unsplash.com/photo-1584820927493-c4c3464ec0c3?w=500&h=300&fit=crop" },
        { title: "Eid al-Fitr", date: eidFitrDate, category: "religious", priority: "high", description: "Celebration marking the end of Ramadan", location: "Muslim countries", photo: "https://images.unsplash.com/photo-1584820927493-c4c3464ec0c1?w=500&h=300&fit=crop" },
        { title: "Eid al-Adha", date: eidAdhaDate, category: "religious", priority: "high", description: "Festival of sacrifice", location: "Muslim countries", photo: "https://images.unsplash.com/photo-1584820927493-c4c3464ec0c2?w=500&h=300&fit=crop" }
    ];

    // Add moving festivals
    movingFestivals.forEach(festival => {
        const dateStr = festival.date.toISOString().split('T')[0];
        indianFestivals.push({
            id: id++,
            title: festival.title,
            date: dateStr,
            endDate: dateStr,
            category: festival.category,
            priority: festival.priority,
            description: festival.description,
            location: festival.location,
            photo: festival.photo
        });
    });

    // ========== MULTI-DAY FESTIVALS ==========
    const multiDayFestivals = [
        // Indian multi-day festivals
        { title: "Durga Puja", startDate: new Date(year, 9, 1 + (year - 2024) % 7), days: 5, category: "religious", location: "West Bengal, Nationwide", photo: "https://images.unsplash.com/photo-1601992688411-1dc47113e276?w=500&h=300&fit=crop" },
        { title: "Navratri", startDate: new Date(year, 9, 1 + (year - 2024) % 7), days: 9, category: "religious", location: "Nationwide", photo: "https://images.unsplash.com/photo-1601992688411-1dc47113e277?w=500&h=300&fit=crop" },
        { title: "Pongal", startDate: new Date(year, 0, 14), days: 4, category: "religious", location: "Tamil Nadu", photo: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8c?w=500&h=300&fit=crop" },
        
        // International multi-day festivals
        { title: "Oktoberfest", startDate: new Date(year, 8, 16), days: 18, category: "cultural", location: "Munich, Germany", photo: "https://images.unsplash.com/photo-1534787238916-9ba6764fd3c6?w=500&h=300&fit=crop" },
        { title: "Rio Carnival", startDate: new Date(year, 1, 25), days: 5, category: "cultural", location: "Rio de Janeiro, Brazil", photo: "https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=500&h=300&fit=crop" }
    ];

    multiDayFestivals.forEach(festival => {
        const startDate = festival.startDate.toISOString().split('T')[0];
        const endDate = new Date(festival.startDate);
        endDate.setDate(endDate.getDate() + festival.days - 1);
        
        indianFestivals.push({
            id: id++,
            title: festival.title,
            date: startDate,
            endDate: endDate.toISOString().split('T')[0],
            category: festival.category,
            priority: "medium",
            description: `${festival.title} celebration`,
            location: festival.location,
            photo: festival.photo
        });
    });

    // ========== MAJOR SPORTS EVENTS (Every 4 years) ==========
    if (year % 4 === 0) {
        const olympicsDate = `${year}-07-15`;
        const worldCupDate = `${year}-06-14`;
        
        const quadrennialEvents = [
            { title: "Summer Olympics", date: olympicsDate, category: "sports", priority: "high", description: "International multi-sport event", location: "Various host cities", photo: "https://images.unsplash.com/photo-1461896836934-ffe607ba8211?w=500&h=300&fit=crop" },
            { title: "FIFA World Cup", date: worldCupDate, category: "sports", priority: "high", description: "International football championship", location: "Various host countries", photo: "https://images.unsplash.com/photo-1599669454699-248893623440?w=500&h=300&fit=crop" }
        ];
        
        quadrennialEvents.forEach(event => {
            indianFestivals.push({
                id: id++,
                title: event.title,
                date: event.date,
                endDate: `${year}-08-15`,
                category: event.category,
                priority: event.priority,
                description: event.description,
                location: event.location,
                photo: event.photo
            });
        });
    }
}

// ========== SPECIAL MAJOR EVENTS ==========
// Kumbh Mela (every 12 years)
const kumbhYears = [2025, 2037, 2049];
kumbhYears.forEach(year => {
    indianFestivals.push({
        id: id++,
        title: "Kumbh Mela",
        date: `${year}-01-15`,
        endDate: `${year}-03-15`,
        category: "religious",
        priority: "high",
        description: "Major Hindu pilgrimage and festival, one of the largest religious gatherings in the world",
        location: "Prayagraj, Haridwar, Nashik, Ujjain",
        photo: "https://images.unsplash.com/photo-1581693530355-195793b0bee3?w=500&h=300&fit=crop"
    });
});

// Cricket World Cup (every 4 years)
const cricketWorldCupYears = [2027, 2031, 2035, 2039, 2043, 2047];
cricketWorldCupYears.forEach(year => {
    indianFestivals.push({
        id: id++,
        title: "Cricket World Cup",
        date: `${year}-10-01`,
        endDate: `${year}-11-15`,
        category: "sports",
        priority: "high",
        description: "International cricket championship",
        location: "Various host countries",
        photo: "https://images.unsplash.com/photo-1531415074968-036ba1b575da?w=500&h=300&fit=crop"
    });
});

console.log(`Total festivals generated: ${indianFestivals.length}`);
console.log(`Covering years: 2024-2050`);
console.log(`Indian & World events combined successfully!`);
    // DOM Elements
    const calendarGrid = document.getElementById("calendarGrid");
    const currentMonthElement = document.getElementById("currentMonth");
    const eventModal = document.getElementById("eventModal");
    const detailsModal = document.getElementById("detailsModal");
    const userEventsList = document.getElementById("userEventsList");
    const upcomingEventsList = document.getElementById("upcomingEventsList");

    // Initialize application
document.addEventListener("DOMContentLoaded", function () {
    // Initialize events with festivals
    events = [...indianFestivals];
    
    // FIRST check login status to set proper UI
    checkLoginStatus();
    
    // THEN setup other things
    setupEventListeners();
    setupNavigation();
    
    // Load system events for all users
    loadSystemEvents();
    
    // Load user events after login status is checked
    setTimeout(() => {
        if (currentUser) {
            loadEventsFromDatabase();
        } else {
            loadEventsFromLocalStorage();
        }
        renderCalendar();
        updateDashboard();
    }, 100);
});

function setupEventListeners() {
        // Calendar navigation
        document.getElementById("prevMonth").addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById("nextMonth").addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        document.getElementById("todayBtn").addEventListener("click", () => {
            currentDate = new Date();
            renderCalendar();
        });

        // View options
        document.querySelectorAll(".view-btn").forEach(btn => {
            btn.addEventListener("click", function() {
                document.querySelectorAll(".view-btn").forEach(b => b.classList.remove("active"));
                this.classList.add("active");
                switchView(this.getAttribute("data-view"));
            });
        });

        // Modal controls
        document.getElementById("closeModal").addEventListener("click", closeEventModal);
        document.getElementById("cancelBtn").addEventListener("click", closeEventModal);
        document.getElementById("modalCancelBtn").addEventListener("click", closeEventModal);

        // User authentication
        document.getElementById("loginBtn").addEventListener("click", showLoginPage);
        document.getElementById("registerBtn").addEventListener("click", showRegisterPage);
        document.getElementById("profileBtn").addEventListener("click", showProfilePage);
        document.getElementById("logoutBtn").addEventListener("click", logout);
        document.getElementById("backFromLogin").addEventListener("click", showDashboard);
        document.getElementById("backFromRegister").addEventListener("click", showDashboard);
        document.getElementById("goToRegister").addEventListener("click", showRegisterPage);
        document.getElementById("goToLogin").addEventListener("click", showLoginPage);

        // Forms
        document.getElementById("eventForm").addEventListener("submit", saveEvent);
        document.getElementById("modalEventForm").addEventListener("submit", saveModalEvent);
        document.getElementById("loginForm").addEventListener("submit", handleLogin);
        document.getElementById("registerForm").addEventListener("submit", handleRegister);
        document.getElementById("profileForm").addEventListener("submit", saveProfile);
        document.getElementById("photoForm").addEventListener("submit", saveProfilePhoto);
        document.getElementById("preferencesForm").addEventListener("submit", savePreferences);
function handleLogin(e) {
    e.preventDefault();
    
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const rememberMe = document.getElementById("rememberMe").checked;
    
    // Validation
    if (!email || !password) {
        showNotification("Please fill in all fields", "error");
        return;
    }
    
    // Create form data for PHP login
    const formData = new FormData();
    formData.append('loginEmail', email);
    formData.append('loginPassword', password);
    formData.append('rememberMe', rememberMe);
    
    // Show loading state
    const loginBtn = document.querySelector('#loginForm button[type="submit"]');
    const originalText = loginBtn.innerHTML;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
    loginBtn.disabled = true;
    
    // Send login request to PHP
    fetch('login.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Set login state
            isLoggedIn = true;
            
            // Get complete user data from response or find in database
            let user;
            if (data.user) {
                user = data.user;
            } else {
                user = usersDatabase.find(u => u.email === email);
            }
            
            if (user) {
                currentUser = user;
                
                // Save to localStorage if remember me is checked
                if (rememberMe) {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                }
                
                // Update UI
                updateUIAfterLogin(user);
                
                // Show dashboard
                showDashboard();
                
                showNotification(`Welcome back, ${user.firstName}!`, "success");
                
                // Load user events from database
                loadEventsFromDatabase();
            } else {
                showNotification("User data not found", "error");
            }
        } else {
            showNotification(data.message || "Login failed", "error");
        }
    })
    .catch(error => {
        console.error('Login error:', error);
        showNotification("Login failed. Please try again.", "error");
    })
    .finally(() => {
        // Reset button state
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
    });
}
        // Profile menu
        document.querySelectorAll(".profile-menu-link").forEach(link => {
            link.addEventListener("click", function(e) {
                e.preventDefault();
                const section = this.getAttribute("data-section");
                showProfileSection(section);
            });
        });

        // AI Assistant
        document.getElementById("aiToggle").addEventListener("click", toggleAIChat);
        document.querySelector(".close-ai").addEventListener("click", toggleAIChat);
        document.getElementById("aiSendBtn").addEventListener("click", sendAIMessage);
        document.getElementById("aiChatInput").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                sendAIMessage();
            }
        });
    }

    function setupNavigation() {
        document.querySelectorAll(".nav-link").forEach(link => {
            link.addEventListener("click", function(e) {
                e.preventDefault();
                const page = this.getAttribute("data-page");
                showPage(page);
            });
        });
    }
function syncProfileData() {
    if (!currentUser) return;
    
    // Update all profile-related elements on the page
    const profileElements = [
        { id: 'userName', value: `${currentUser.firstName} ${currentUser.lastName}` },
        { id: 'profileName', value: `${currentUser.firstName} ${currentUser.lastName}` },
        { id: 'profileEmail', value: currentUser.email }
    ];
    
    profileElements.forEach(element => {
        const el = document.getElementById(element.id);
        if (el) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.value = element.value;
            } else {
                el.textContent = element.value;
            }
        }
    });
    
    console.log(" Profile data synced");
}

// Call this whenever user data changes
function updateCurrentUser(newData) {
    if (currentUser) {
        currentUser = { ...currentUser, ...newData };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        syncProfileData();
    }
}
    function showPage(page) {
        // Hide all pages
        document.querySelectorAll(".page-content").forEach(p => {
            p.classList.remove("active");
        });

        // Remove active class from all nav links
        document.querySelectorAll(".nav-link").forEach(link => {
            link.classList.remove("active");
        });

        // Show selected page and set active nav link
        document.getElementById(`${page}-page`).classList.add("active");
        document.querySelector(`.nav-link[data-page="${page}"]`).classList.add("active");

        // Special handling for specific pages
        if (page === "calendar") {
            renderCalendar();
        } else if (page === "my-events") {
            loadUserEvents();
        }
    }

    function showDashboard() {
    // Make sure we're actually showing the dashboard page
    document.querySelectorAll(".page-content").forEach(p => {
        p.classList.remove("active");
    });

    // Remove active class from all nav links
    document.querySelectorAll(".nav-link").forEach(link => {
        link.classList.remove("active");
    });

    // Show dashboard page and set active nav link
    document.getElementById("dashboard-page").classList.add("active");
    document.querySelector('.nav-link[data-page="dashboard"]').classList.add("active");
    
    // Update dashboard content
    updateDashboard();
}

    function showLoginPage() {
        document.querySelectorAll(".page-content").forEach(p => {
            p.classList.remove("active");
        });
        document.getElementById("login-page").classList.add("active");
    }

    function showRegisterPage() {
        document.querySelectorAll(".page-content").forEach(p => {
            p.classList.remove("active");
        });
        document.getElementById("register-page").classList.add("active");
    }

    function showProfilePage() {
        showPage("profile");
        loadUserProfile();
    }
function showProfileSection(section) {
    // Hide all profile sections
    document.querySelectorAll(".profile-section").forEach(s => {
        s.classList.remove("active");
    });

    // Remove active class from all profile menu links
    document.querySelectorAll(".profile-menu-link").forEach(link => {
        link.classList.remove("active");
    });

    // Show selected section and set active menu link
    document.getElementById(`${section}-section`).classList.add("active");
    document.querySelector(`.profile-menu-link[data-section="${section}"]`).classList.add("active");

    // RELOAD DATA FOR ALL SECTIONS
    if (currentUser) {
        if (section === "edit-profile") {
            // Data is already loaded by updateAllProfileData
            console.log(" Edit Profile section loaded");
        } else if (section === "my-events") {
            loadProfileEvents();
        } else if (section === "preferences") {
            // Preferences are already loaded by updateAllProfileData
            console.log(" Preferences section loaded");
        }
    }
}
  function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update current month display
    currentMonthElement.textContent = `${currentDate.toLocaleString("default", { month: "long" })} ${year}`;

    // Clear previous calendar
    calendarGrid.innerHTML = "";

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Create empty cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement("div");
        emptyDay.classList.add("calendar-day", "empty-day");
        emptyDay.innerHTML = '<div class="empty-state"> </div>';
        calendarGrid.appendChild(emptyDay);
    }

    // Create cells for each day of the month
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement("div");
        dayElement.classList.add("calendar-day");

        // Format date for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        // Check if this day is today
        const currentDay = new Date(dateStr);
        currentDay.setHours(0, 0, 0, 0);
        if (currentDay.getTime() === today.getTime()) {
            dayElement.classList.add("today");
        }

        // Day header with number and add button
        const dayHeader = document.createElement("div");
        dayHeader.classList.add("day-header");

        const dayNumber = document.createElement("span");
        dayNumber.classList.add("day-number");
        dayNumber.textContent = day;

        const addButton = document.createElement("button");
        addButton.classList.add("add-event-btn");
        addButton.innerHTML = "<i class='fas fa-plus'></i>";
        addButton.title = "Add Event on " + dateStr;
        addButton.addEventListener("click", (e) => {
            e.stopPropagation();
            openAddEventModal(dateStr);
        });

        dayHeader.appendChild(dayNumber);
        dayHeader.appendChild(addButton);
        dayElement.appendChild(dayHeader);

        // Add events for this day
        const dayEvents = getEventsForDate(dateStr);

        // Show event count badge if there are events
        if (dayEvents.length > 0) {
            const eventCount = document.createElement("div");
            eventCount.classList.add("event-count");
            eventCount.textContent = dayEvents.length;
            eventCount.title = `${dayEvents.length} events`;
            dayElement.appendChild(eventCount);
        }

        // Events container
        const eventsContainer = document.createElement("div");
        eventsContainer.classList.add("events-container");

        if (dayEvents.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.classList.add("empty-state");
            emptyState.textContent = "";
            eventsContainer.appendChild(emptyState);
        } else {
            dayEvents.forEach(event => {
                const eventElement = document.createElement("div");
                eventElement.classList.add("event", `event-${event.category || 'personal'}`);
                eventElement.title = `${event.title} - Click for details`;

                const eventIcon = document.createElement("i");
                eventIcon.className = getEventIcon(event.category);
                eventIcon.style.marginRight = "5px";

                const eventTitle = document.createElement("span");
                eventTitle.textContent = event.title || "Untitled Event";

                eventElement.appendChild(eventIcon);
                eventElement.appendChild(eventTitle);

                // Add click event to view details
                eventElement.addEventListener("click", (e) => {
                    e.stopPropagation();
                    openEventDetails(event);
                });

                eventsContainer.appendChild(eventElement);
            });
        }

        dayElement.appendChild(eventsContainer);
        calendarGrid.appendChild(dayElement);
    }
}

// Helper function to get appropriate icon for event category
function getEventIcon(category) {
    switch(category) {
        case 'festival': return 'fas fa-gifts';
        case 'national': return 'fas fa-flag';
        case 'religious': return 'fas fa-pray';
        case 'cultural': return 'fas fa-music';
        case 'personal': return 'fas fa-user';
        default: return 'fas fa-calendar';
    }
}

function getEventsForDate(dateStr) {
    if (!events || events.length === 0) return [];
    
    return events.filter(event => {
        if (!event.date) return false;
        
        const eventDate = new Date(event.date);
        const eventEndDate = event.endDate ? new Date(event.endDate) : eventDate;
        const currentDate = new Date(dateStr);

        return currentDate >= eventDate && currentDate <= eventEndDate;
    });
}
   // Update the event form to include time fields
function openAddEventModal(dateStr) {
    if (!isLoggedIn) {
        showNotification("Please login to add events", "warning");
        showLoginPage();
        return;
    }

    selectedDate = dateStr;
    editingEventId = null;

    // Reset and populate the modal form
    document.getElementById("modalEventForm").reset();
    document.getElementById("modalSelectedDate").value = dateStr;
    document.getElementById("modalEventId").value = "";
    document.getElementById("modalTitle").textContent = "Add New Event";
    
    // Set the dates to the selected date
    document.getElementById("modalStartDate").value = dateStr;
    document.getElementById("modalEndDate").value = dateStr;
    
    // Set default times
    document.getElementById("modalStartTime").value = "09:00";
    document.getElementById("modalEndTime").value = "17:00";
    
    // Set default category and priority
    document.getElementById("modalEventCategory").value = "personal";
    document.getElementById("modalEventPriority").value = "medium";
    
    // Clear photo preview
    document.getElementById("modalPhotoPreview").style.display = "none";
    document.getElementById("modalEventPhoto").value = "";

    // Show the modal
    eventModal.style.display = "flex";
}
  function openEventDetails(event) {
    if (!event) {
        showNotification("Event data not available", "error");
        return;
    }

    // Set modal title and content with fallbacks
    document.getElementById("detailsTitle").textContent = event.title || "Untitled Event";
    document.getElementById("detailsDate").textContent = formatEventDate(event);
    document.getElementById("detailsCategory").textContent = (event.category || 'personal').charAt(0).toUpperCase() + (event.category || 'personal').slice(1);
    document.getElementById("detailsLocation").textContent = event.location || "Not specified";
    document.getElementById("detailsPriority").textContent = (event.priority || 'medium').charAt(0).toUpperCase() + (event.priority || 'medium').slice(1);
    document.getElementById("detailsDescription").textContent = event.description || "No description available.";

    // Handle event image
    const detailsImage = document.getElementById("detailsImage");
    if (event.photo) {
        detailsImage.src = event.photo;
        detailsImage.style.display = "block";
    } else {
        detailsImage.style.display = "none";
    }

    // Show holiday information for system events and festivals
    const holidayInfo = document.getElementById("holidayInfo");
    if (event.holidayInfo || event.isSystemEvent) {
        document.getElementById("holidayContent").textContent = event.holidayInfo?.content || event.description || "This is a system event.";
        document.getElementById("holidayImage").src = event.holidayInfo?.image || getDefaultHolidayImage(event.eventType || event.category);
        holidayInfo.style.display = "block";
    } else {
        holidayInfo.style.display = "none";
    }

    detailsModal.style.display = "flex";
}

   function closeEventModal() {
        eventModal.style.display = "none";
        editingEventId = null;
    }

    function closeDetailsModal() {
        detailsModal.style.display = "none";
    }

    function previewPhoto(event) {
        const file = event.target.files[0];
        const preview = document.getElementById("photoPreview");

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    }

    function previewModalPhoto(event) {
        const file = event.target.files[0];
        const preview = document.getElementById("modalPhotoPreview");

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    }

    function previewProfilePhoto(event) {
        const file = event.target.files[0];
        const preview = document.getElementById("profilePhotoPreview");

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    }

   function saveEvent(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        showLoginPage();
        return;
    }

    // Get form data with proper validation
    const eventData = {
        eventTitle: document.getElementById("eventTitle").value.trim(),
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        startTime: document.getElementById("modalStartTime").value || "09:00",
        endTime: document.getElementById("modalEndTime").value || "17:00",
        eventCategory: document.getElementById("eventCategory").value,
        eventPriority: document.getElementById("eventPriority").value,
        eventDescription: document.getElementById("eventDescription").value.trim(),
        eventLocation: document.getElementById("eventLocation").value.trim(),
        userId: currentUser.id
    };

    // Validate required fields
    if (!eventData.eventTitle) {
        showNotification("Event title is required", "error");
        return;
    }

    if (!eventData.startDate || !eventData.endDate) {
        showNotification("Start date and end date are required", "error");
        return;
    }

    // Create form data for PHP
    const formData = new FormData();
    Object.keys(eventData).forEach(key => {
        formData.append(key, eventData[key]);
    });

    // Handle photo upload
    const photoFile = document.getElementById("eventPhoto").files[0];
    if (photoFile) {
        formData.append('eventPhoto', photoFile);
    }

    // Show loading state
    const saveBtn = document.querySelector('#eventForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    // Send to PHP backend
    fetch('save_event.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Create complete event object for frontend
            const newEvent = {
                id: data.eventId || Date.now(),
                title: eventData.eventTitle,
                date: eventData.startDate,
                endDate: eventData.endDate,
                startTime: eventData.startTime,
                endTime: eventData.endTime,
                category: eventData.eventCategory,
                priority: eventData.eventPriority,
                description: eventData.eventDescription,
                location: eventData.eventLocation,
                photo: data.photo_url || '',
                userId: currentUser.id
            };

            // Add to user events array
            userEvents.push(newEvent);

            // Update events array (combine festivals and user events)
            events = [...indianFestivals, ...userEvents];

            // Save to localStorage as backup
            saveEventsToStorage();

            // Update all UI components
            refreshAllEventDisplays();

            // Reset form
            document.getElementById("eventForm").reset();
            document.getElementById("photoPreview").style.display = "none";

            showNotification("Event saved successfully!", "success");
            
            // Auto-switch to My Events page
            setTimeout(() => {
                showPage("my-events");
            }, 1000);
        } else {
            showNotification(data.message || "Failed to save event", "error");
        }
    })
    .catch(error => {
        console.error('Save event error:', error);
        showNotification("Failed to save event. Please try again.", "error");
    })
    .finally(() => {
        // Reset button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}
function saveModalEvent(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        return;
    }

    // Get all form data with validation
    const eventData = {
        eventId: document.getElementById("modalEventId").value || Date.now(),
        eventTitle: document.getElementById("modalEventTitle").value.trim(),
        startDate: document.getElementById("modalStartDate").value,
        endDate: document.getElementById("modalEndDate").value,
        startTime: document.getElementById("modalStartTime").value || "09:00",
        endTime: document.getElementById("modalEndTime").value || "17:00",
        eventCategory: document.getElementById("modalEventCategory").value,
        eventPriority: document.getElementById("modalEventPriority").value,
        eventDescription: document.getElementById("modalEventDescription").value.trim(),
        eventLocation: document.getElementById("modalEventLocation").value.trim(),
        userId: currentUser.id
    };

    // Validate required fields
    if (!eventData.eventTitle) {
        showNotification("Event title is required", "error");
        document.getElementById("modalEventTitle").focus();
        return;
    }

    if (!eventData.startDate || !eventData.endDate) {
        showNotification("Start date and end date are required", "error");
        return;
    }

    // Create form data for PHP
    const formData = new FormData();
    Object.keys(eventData).forEach(key => {
        formData.append(key, eventData[key]);
    });

    // Handle photo upload for modal
    const photoFile = document.getElementById("modalEventPhoto").files[0];
    if (photoFile) {
        formData.append('eventPhoto', photoFile);
    }

    // Show loading state
    const saveBtn = document.querySelector('#modalEventForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    // Send to PHP backend
    fetch('save_event.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Create complete event object for frontend
            const newEvent = {
                id: data.eventId || eventData.eventId,
                title: eventData.eventTitle,
                date: eventData.startDate,
                endDate: eventData.endDate,
                startTime: eventData.startTime,
                endTime: eventData.endTime,
                category: eventData.eventCategory,
                priority: eventData.eventPriority,
                description: eventData.eventDescription,
                location: eventData.eventLocation,
                photo: data.photo_url || '',
                userId: currentUser.id
            };

            // Check if we're editing an existing event
            const existingIndex = userEvents.findIndex(e => e.id == eventData.eventId);
            if (existingIndex >= 0) {
                // Update existing event
                userEvents[existingIndex] = newEvent;
            } else {
                // Add new event
                userEvents.push(newEvent);
            }

            // Update events array (combine festivals and user events)
            events = [...indianFestivals, ...userEvents];

            // Save to localStorage as backup
            saveEventsToStorage();

            // Update all UI components
            refreshAllEventDisplays();

            // Close modal
            closeEventModal();

            showNotification("Event saved successfully!", "success");
            
            // Auto-switch to Calendar page to see the new event
            setTimeout(() => {
                showPage("calendar");
            }, 500);
        } else {
            showNotification(data.message || "Failed to save event", "error");
        }
    })
    .catch(error => {
        console.error('Save modal event error:', error);
        showNotification("Failed to save event. Please try again.", "error");
    })
    .finally(() => {
        // Reset button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}
   function completeSave(eventData, isNew = true) {
    // Add to user events
    if (isNew) {
        userEvents.push(eventData);
    } else {
        const existingIndex = userEvents.findIndex(e => e.id == eventData.id);
        if (existingIndex >= 0) {
            userEvents[existingIndex] = eventData;
        }
    }

    // Update events array
    events = [...indianFestivals, ...userEvents];

    // Save to localStorage
    saveEventsToStorage();

    // Update UI
    renderCalendar();
    updateDashboard();
    loadUserEvents();
    loadProfileEvents();
    closeEventModal();

    showNotification("Event saved successfully!", "success");
}
    function switchView(view) {
        // For this example, we only have month view
        showNotification(`Switching to ${view} view - This would show a specialized view for ${view}`, "info");
    }

    function formatEventDate(event) {
        const startDate = new Date(event.date);
        const endDate = new Date(event.endDate);

        if (event.date === event.endDate) {
            return startDate.toLocaleDateString("en-US", {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric"
            });
        } else {
            return `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
        }
    }

    // User Authentication Functions
   f
   function handleRegister(e) {
    e.preventDefault();
    
    const firstName = document.getElementById("firstName").value;
    const lastName = document.getElementById("lastName").value;
    const email = document.getElementById("registerEmail").value;
    const password = document.getElementById("registerPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    const agreeTerms = document.getElementById("agreeTerms").checked;
    
    // Validation
    if (!firstName || !lastName || !email || !password || !confirmPassword) {
        showNotification("Please fill in all fields", "error");
        return;
    }
    
    if (password !== confirmPassword) {
        showNotification("Passwords do not match", "error");
        return;
    }
    
    if (!agreeTerms) {
        showNotification("Please agree to the terms and conditions", "error");
        return;
    }
    
    // Create form data for PHP registration
    const formData = new FormData();
    formData.append('firstName', firstName);
    formData.append('lastName', lastName);
    formData.append('registerEmail', email);
    formData.append('registerPassword', password);
    formData.append('confirmPassword', confirmPassword);
    
    // Show loading state
    const registerBtn = document.querySelector('#registerForm button[type="submit"]');
    const originalText = registerBtn.innerHTML;
    registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
    registerBtn.disabled = true;
    
    // Send registration request to PHP
    fetch('register.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Create complete user object with all profile data
            const newUser = {
                id: data.user.id || data.userId,
                firstName: data.user.firstName || firstName,
                lastName: data.user.lastName || lastName,
                email: data.user.email || email,
                password: password, // Note: In real app, don't store plain password
                phone: data.user.phone || "",
                bio: data.user.bio || "",
                profile_picture: data.user.profile_picture || "",
                preferences: {
                    notifications: "all",
                    timezone: "ist",
                    language: "en",
                    emailUpdates: true
                }
            };
            
            // Update local database
            const existingIndex = usersDatabase.findIndex(u => u.email === newUser.email);
            if (existingIndex >= 0) {
                usersDatabase[existingIndex] = newUser;
            } else {
                usersDatabase.push(newUser);
            }
            
            // Set login state
            isLoggedIn = true;
            currentUser = newUser;
            
            // Save to localStorage for persistence
            localStorage.setItem('currentUser', JSON.stringify(newUser));
            
            // AUTOMATICALLY UPDATE ALL PROFILE DATA
            updateAllProfileData(newUser);
            
            // Show dashboard
            showDashboard();
            
            showNotification(`Welcome to Smart Calendar, ${newUser.firstName}!`, "success");
            
            // Auto-switch to profile page after 2 seconds to show updated data
            setTimeout(() => {
                showProfilePage();
            }, 2000);
            
        } else {
            showNotification(data.message || "Registration failed", "error");
        }
    })
    .catch(error => {
        console.error('Registration error:', error);
        showNotification("Registration failed. Please try again.", "error");
    })
    .finally(() => {
        // Reset button state
        registerBtn.innerHTML = originalText;
        registerBtn.disabled = false;
    });
}
function updateAllProfileData(user) {
    console.log(" AUTOMATIC PROFILE UPDATE:", user);
    
    if (!user) return;
    
    // Update user menu
    document.getElementById("userName").textContent = `${user.firstName} ${user.lastName}`;
    document.getElementById("userMenu").style.display = "flex";
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("registerBtn").style.display = "none";
    
    // Update profile header
    document.getElementById("profileName").textContent = `${user.firstName} ${user.lastName}`;
    document.getElementById("profileEmail").textContent = user.email;
    
    // Update profile form fields
    const profileFields = {
        'profileFirstName': user.firstName,
        'profileLastName': user.lastName,
        'profileEmailInput': user.email,
        'profilePhone': user.phone || "",
        'profileBio': user.bio || ""
    };
    
    // Update each field
    Object.keys(profileFields).forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = profileFields[fieldId];
        }
    });
    
    // Update profile picture if available
    if (user.profile_picture) {
        const avatar = document.getElementById("profileAvatar");
        if (avatar) {
            avatar.src = user.profile_picture;
        }
    }
    
    // Update preferences if they exist
    if (user.preferences) {
        const prefFields = {
            'notificationPref': user.preferences.notifications,
            'timezonePref': user.preferences.timezone,
            'languagePref': user.preferences.language
        };
        
        Object.keys(prefFields).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = prefFields[fieldId];
            }
        });
        
        const emailUpdates = document.getElementById('emailUpdates');
        if (emailUpdates) {
            emailUpdates.checked = user.preferences.emailUpdates !== false;
        }
    }
    
    // Add welcome message to dashboard
    updateWelcomeMessage(user.firstName);
    
    console.log(" PROFILE UPDATE COMPLETE");
}
function updateWelcomeMessage(firstName) {
    const dashboardPage = document.getElementById("dashboard-page");
    let welcomeMessage = document.querySelector(".welcome-back");
    
    if (!welcomeMessage) {
        welcomeMessage = document.createElement("div");
        welcomeMessage.classList.add("welcome-back");
        dashboardPage.insertBefore(welcomeMessage, dashboardPage.firstChild);
    }
    welcomeMessage.textContent = `Welcome to Smart Calendar, ${firstName}!`;
}
// Helper function to update UI after login/registration
function updateUIAfterLogin(user) {
    // Make sure all user data is properly set
    currentUser = user;
    
    document.getElementById("userName").textContent = `${user.firstName} ${user.lastName}`;
    document.getElementById("userMenu").style.display = "flex";
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("registerBtn").style.display = "none";
    
    // Update profile information immediately
    updateProfileDisplay(user);
    
    // Add welcome message to dashboard
    const dashboardPage = document.getElementById("dashboard-page");
    let welcomeMessage = document.querySelector(".welcome-back");
    if (!welcomeMessage) {
        welcomeMessage = document.createElement("div");
        welcomeMessage.classList.add("welcome-back");
        dashboardPage.insertBefore(welcomeMessage, dashboardPage.firstChild);
    }
    welcomeMessage.textContent = `Welcome, ${user.firstName}!`;
}

function updateProfileDisplay(user) {
    console.log("Updating profile display with:", user); // Debug log
    
    // Update profile header
    document.getElementById("profileName").textContent = `${user.firstName} ${user.lastName}`;
    document.getElementById("profileEmail").textContent = user.email;
    
    // Update form fields - DOUBLE CHECK THESE IDS
    const firstNameField = document.getElementById("profileFirstName");
    const lastNameField = document.getElementById("profileLastName");
    const emailField = document.getElementById("profileEmailInput");
    const phoneField = document.getElementById("profilePhone");
    const bioField = document.getElementById("profileBio");
    
    if (firstNameField) firstNameField.value = user.firstName || "";
    if (lastNameField) lastNameField.value = user.lastName || "";
    if (emailField) emailField.value = user.email || "";
    if (phoneField) phoneField.value = user.phone || "";
    if (bioField) bioField.value = user.bio || "";
    
    // Update user menu
    document.getElementById("userName").textContent = `${user.firstName} ${user.lastName}`;
}
// Function to update profile display
function updateProfileDisplay(user) {
    document.getElementById("profileName").textContent = `${user.firstName} ${user.lastName}`;
    document.getElementById("profileEmail").textContent = user.email;
    document.getElementById("profileFirstName").value = user.firstName;
    document.getElementById("profileLastName").value = user.lastName;
    document.getElementById("profileEmailInput").value = user.email;
    document.getElementById("profilePhone").value = user.phone || "";
    document.getElementById("profileBio").value = user.bio || "";
}
    function logout() {
        isLoggedIn = false;
        currentUser = null;
        
        // Remove from localStorage
        localStorage.removeItem('currentUser');
        
        // Update UI - Show login/register buttons, hide user menu
        document.getElementById("userMenu").style.display = "none";
        document.getElementById("loginBtn").style.display = "inline-block";
        document.getElementById("registerBtn").style.display = "inline-block";
        
        // Show dashboard after logout (not login page)
        showDashboard();
        
        showNotification("You have been logged out", "info");
    }

 function checkLoginStatus() {
    // Check if user is stored in localStorage
    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
        try {
            const user = JSON.parse(storedUser);
            
            // Set login state
            isLoggedIn = true;
            currentUser = user;
            
            // Update UI to show user is logged in
            document.getElementById("userName").textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById("userMenu").style.display = "flex";
            document.getElementById("loginBtn").style.display = "none";
            document.getElementById("registerBtn").style.display = "none";
            
            // AUTOMATICALLY UPDATE PROFILE DATA
            updateAllProfileData(user);
            
            // IMPORTANT: Show dashboard immediately for logged-in users
            showDashboard();
            
            console.log(" User auto-logged in:", user.firstName);
            
        } catch (error) {
            console.error("Error parsing stored user:", error);
            localStorage.removeItem('currentUser');
            // Show login/register buttons if there's an error
            document.getElementById("userMenu").style.display = "none";
            document.getElementById("loginBtn").style.display = "inline-block";
            document.getElementById("registerBtn").style.display = "inline-block";
        }
    } else {
        // Show login/register buttons for non-logged in users
        document.getElementById("userMenu").style.display = "none";
        document.getElementById("loginBtn").style.display = "inline-block";
        document.getElementById("registerBtn").style.display = "inline-block";
    }
}
function loadUserProfile() {
    if (currentUser) {
        console.log(" LOADING PROFILE FOR:", currentUser);
        updateAllProfileData(currentUser);
    } else {
        console.log(" No current user found for profile loading");
        showNotification("Please log in to view your profile", "warning");
        showLoginPage();
    }
    if (currentUser) {
        console.log("Loading profile for:", currentUser); // Debug log
        
        // Update profile header
        document.getElementById("profileName").textContent = `${currentUser.firstName} ${currentUser.lastName}`;
        document.getElementById("profileEmail").textContent = currentUser.email;
        
        // Update form fields - MAKE SURE THESE IDS MATCH YOUR HTML
        document.getElementById("profileFirstName").value = currentUser.firstName || "";
        document.getElementById("profileLastName").value = currentUser.lastName || "";
        document.getElementById("profileEmailInput").value = currentUser.email || "";
        document.getElementById("profilePhone").value = currentUser.phone || "";
        document.getElementById("profileBio").value = currentUser.bio || "";
        
        // Update profile picture if available
        if (currentUser.profile_picture) {
            document.getElementById("profileAvatar").src = currentUser.profile_picture;
        }
        
        // Load preferences
        if (currentUser.preferences) {
            document.getElementById("notificationPref").value = currentUser.preferences.notifications || "all";
            document.getElementById("timezonePref").value = currentUser.preferences.timezone || "ist";
            document.getElementById("languagePref").value = currentUser.preferences.language || "en";
            document.getElementById("emailUpdates").checked = currentUser.preferences.emailUpdates !== false;
        }
        
        // Also update the user menu name
        document.getElementById("userName").textContent = `${currentUser.firstName} ${currentUser.lastName}`;
    } else {
        console.log("No current user found"); // Debug log
    }
}
   function saveProfile(e) {
    e.preventDefault();
    
    if (currentUser) {
        // Get updated values
        const updatedFirstName = document.getElementById("profileFirstName").value;
        const updatedLastName = document.getElementById("profileLastName").value;
        const updatedEmail = document.getElementById("profileEmailInput").value;
        const updatedPhone = document.getElementById("profilePhone").value;
        const updatedBio = document.getElementById("profileBio").value;
        
        // Create form data for PHP update
        const formData = new FormData();
        formData.append('userId', currentUser.id);
        formData.append('firstName', updatedFirstName);
        formData.append('lastName', updatedLastName);
        formData.append('email', updatedEmail);
        formData.append('phone', updatedPhone);
        formData.append('bio', updatedBio);
        
        // Send update request to PHP
        fetch('update_profile.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update local user data
                currentUser.firstName = updatedFirstName;
                currentUser.lastName = updatedLastName;
                currentUser.email = updatedEmail;
                currentUser.phone = updatedPhone;
                currentUser.bio = updatedBio;
                
                // Update UI
                document.getElementById("profileName").textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                document.getElementById("profileEmail").textContent = currentUser.email;
                document.getElementById("userName").textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                
                // Update localStorage if user is remembered
                if (localStorage.getItem('currentUser')) {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                showNotification("Profile updated successfully!", "success");
            } else {
                showNotification(data.message || "Failed to update profile", "error");
            }
        })
        .catch(error => {
            console.error('Profile update error:', error);
            showNotification("Failed to update profile. Please try again.", "error");
        });
    }
}
function saveProfilePhoto(e) {
    e.preventDefault();
    
    if (!currentUser) {
        showNotification("Please login to update profile photo", "error");
        return;
    }

    const file = document.getElementById("profilePhotoUpload").files[0];
    if (!file) {
        showNotification("Please select a photo to upload", "error");
        return;
    }

    // Create form data
    const formData = new FormData();
    formData.append('userId', currentUser.id);
    formData.append('profilePhotoUpload', file);

    // Show loading state
    const saveBtn = document.querySelector('#photoForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    saveBtn.disabled = true;

    // Send to PHP backend
    fetch('update_photo.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update current user data with complete user info from server
            currentUser = { ...currentUser, ...data.user };
            
            // Update localStorage if user is remembered
            if (localStorage.getItem('currentUser')) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            
            // Update profile avatar everywhere on the page
            updateProfilePhotoEverywhere(data.photo_url);
            
            // Reset form
            document.getElementById("photoForm").reset();
            document.getElementById("profilePhotoPreview").style.display = "none";
            
            showNotification("Profile photo updated successfully!", "success");
            
            // Refresh profile data to ensure everything is updated
            setTimeout(() => {
                updateAllProfileData(currentUser);
            }, 500);
            
        } else {
            showNotification(data.message || "Failed to update profile photo", "error");
        }
    })
    .catch(error => {
        console.error('Profile photo update error:', error);
        showNotification("Failed to update profile photo. Please try again.", "error");
    })
    .finally(() => {
        // Reset button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// Function to update profile photo everywhere on the page
function updateProfilePhotoEverywhere(photoUrl) {
    // Update profile avatar in sidebar
    const profileAvatar = document.getElementById("profileAvatar");
    if (profileAvatar) {
        profileAvatar.src = photoUrl;
    }
    
    // Update any other potential profile photo locations
    const allProfileImages = document.querySelectorAll('img[src*="profile"]');
    allProfileImages.forEach(img => {
        if (img.id !== 'profilePhotoPreview') {
            img.src = photoUrl;
        }
    });
    
    console.log(" Profile photo updated everywhere:", photoUrl);
}
// Add Delete Event Function
function deleteEvent(eventId) {
    if (!confirm("Are you sure you want to delete this event?")) {
        return;
    }

    if (!currentUser) {
        showNotification("Please login to delete events", "error");
        return;
    }

    // Create form data for PHP
    const formData = new FormData();
    formData.append('eventId', eventId);
    formData.append('userId', currentUser.id);

    fetch('delete_event.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Remove from user events array
            userEvents = userEvents.filter(event => event.id != eventId);
            
            // Update events array
            events = [...indianFestivals, ...userEvents];

            // Update localStorage
            saveEventsToStorage();

            // Update UI
            renderCalendar();
            updateDashboard();
            loadUserEvents();
            loadProfileEvents();

            showNotification("Event deleted successfully!", "success");
        } else {
            showNotification(data.message || "Failed to delete event", "error");
        }
    })
    .catch(error => {
        console.error('Delete event error:', error);
        showNotification("Failed to delete event. Please try again.", "error");
    });
}
function loadEventsFromStorage() {
    // Always try to load from database first
    if (currentUser) {
        loadEventsFromDatabase();
    } else {
        // Fallback to localStorage for non-logged in users
        const storedEvents = JSON.parse(localStorage.getItem('userEvents') || '[]');
        userEvents = storedEvents;
        events = [...indianFestivals, ...userEvents];
    }
}

function loadEventsFromDatabase() {
    if (!currentUser) return;
    
    fetch(`get_events.php?userId=${currentUser.id}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log("Loaded events from database:", data.events);
            
            // Convert database events to frontend format
            const dbEvents = data.events.map(event => ({
                id: event.id,
                title: event.title || event.eventTitle,
                date: event.start_date || event.date,
                endDate: event.end_date || event.endDate,
                startTime: event.start_time || event.startTime || '09:00',
                endTime: event.end_time || event.endTime || '17:00',
                category: event.category || event.eventCategory,
                priority: event.priority || event.eventPriority,
                description: event.description || event.eventDescription,
                location: event.location || event.eventLocation,
                photo: event.photo,
                userId: event.user_id || event.userId
            }));
            
            userEvents = dbEvents;
            events = [...indianFestivals, ...userEvents];
            
            // Update localStorage with database events as backup
            saveEventsToStorage();
            
            // Update UI
            refreshAllEventDisplays();
        } else {
            console.error('Failed to load events from database:', data.message);
            // Fallback to localStorage
            loadEventsFromLocalStorage();
        }
    })
    .catch(error => {
        console.error('Load events from database error:', error);
        // Fallback to localStorage
        loadEventsFromLocalStorage();
    });
}

function loadEventsFromLocalStorage() {
    const storedEvents = JSON.parse(localStorage.getItem('userEvents') || '[]');
    userEvents = storedEvents;
    events = [...indianFestivals, ...userEvents];
    refreshAllEventDisplays();
}

function saveEventsToStorage() {
    localStorage.setItem('userEvents', JSON.stringify(userEvents));
}
function loadEventsFromDatabase() {
    if (!currentUser) return;
    
    fetch(`get_events.php?userId=${currentUser.id}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log("Loaded events from database:", data.events);
            
            // Convert database events to frontend format
            const dbEvents = data.events.map(event => ({
                id: event.id,
                title: event.title,
                date: event.start_date || event.date,
                endDate: event.end_date || event.endDate,
                startTime: event.start_time || event.startTime || '00:00',
                endTime: event.end_time || event.endTime || '23:59',
                category: event.category,
                priority: event.priority,
                description: event.description,
                location: event.location,
                photo: event.photo,
                userId: event.user_id || event.userId
            }));
            
            userEvents = dbEvents;
            events = [...indianFestivals, ...userEvents];
            
            // Update localStorage with database events
            saveEventsToStorage();
            
            // Update UI
            renderCalendar();
            updateDashboard();
            loadUserEvents();
            loadProfileEvents();
        } else {
            console.error('Failed to load events:', data.message);
            loadEventsFromStorage(); // Fallback to localStorage
        }
    })
    .catch(error => {
        console.error('Load events error:', error);
        loadEventsFromStorage(); // Fallback to localStorage
    });
}

// Call this function whenever events are added, updated, or deleted
// Add Delete Event Function End

   // Update the loadUserEvents function to show time
function loadUserEvents() {
    const userEventsList = document.getElementById("userEventsList");
    if (!userEventsList) return;
    
    userEventsList.innerHTML = "";
    
    // Check if user is logged in
    if (!currentUser) {
        userEventsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                Please log in to view your events
            </div>
        `;
        return;
    }
    
    // Filter events for current user only
    const userSpecificEvents = userEvents.filter(event => 
        event.userId === currentUser.id
    );
    
    if (userSpecificEvents.length === 0) {
        userEventsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-plus"></i>
                You haven't created any events yet. 
                <br><small>Click "Add Event" to create your first event!</small>
            </div>
        `;
        return;
    }
    
    // Sort events by date (newest first)
    const sortedEvents = userSpecificEvents.sort((a, b) => {
        const dateA = new Date(a.date + ' ' + (a.startTime || '00:00'));
        const dateB = new Date(b.date + ' ' + (b.startTime || '00:00'));
        return dateB - dateA; // Newest first
    });
    
    sortedEvents.forEach(event => {
        const eventElement = document.createElement("div");
        eventElement.classList.add("event-item");
        
        // Format date with validation
        let formattedDate = "Date not set";
        let day = "?";
        let month = "???";
        
        try {
            const eventDate = new Date(event.date);
            if (!isNaN(eventDate.getTime())) {
                formattedDate = eventDate.toLocaleDateString("en-US", {
                    weekday: "short",
                    year: "numeric",
                    month: "short",
                    day: "numeric"
                });
                day = eventDate.getDate();
                month = eventDate.toLocaleString('default', { month: 'short' });
            }
        } catch (error) {
            console.error("Date formatting error:", error);
        }
        
        // Format time with validation
        const startTime = event.startTime ? formatTime(event.startTime) : 'All Day';
        const endTime = event.endTime ? formatTime(event.endTime) : '';
        const timeDisplay = endTime ? `${startTime} - ${endTime}` : startTime;
        
        // Ensure all fields have fallback values
        const eventTitle = event.title || "Untitled Event";
        const eventLocation = event.location || "No location specified";
        const eventDescription = event.description || "No description provided";
        const eventCategory = event.category || "personal";
        
        eventElement.innerHTML = `
            <div class="event-date">
                <div class="day">${day}</div>
                <div class="month">${month}</div>
            </div>
            <div class="event-details">
                <h4>${eventTitle}</h4>
                <p><i class="fas fa-calendar"></i> ${formattedDate}</p>
                <p><i class="fas fa-clock"></i> ${timeDisplay}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${eventLocation}</p>
                <small>${eventDescription}</small>
            </div>
            <div class="event-category ${eventCategory}">
                ${eventCategory.charAt(0).toUpperCase() + eventCategory.slice(1)}
            </div>
            <button class="btn btn-danger btn-sm" onclick="deleteEvent(${event.id})" title="Delete Event">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        userEventsList.appendChild(eventElement);
    });
}
   // Helper function to format time
// Helper function to format time properly
function formatTime(timeString) {
    if (!timeString || timeString === '00:00') return 'All Day';
    
    try {
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const formattedHour = hour % 12 || 12;
        
        return `${formattedHour}:${minutes} ${ampm}`;
    } catch (error) {
        return timeString;
    }
}


// Enhanced event date validation
function getEventsForDate(dateStr) {
    if (!events || events.length === 0) return [];
    
    const currentDate = new Date(dateStr);
    currentDate.setHours(0, 0, 0, 0);
    
    return events.filter(event => {
        if (!event.date) return false;
        
        try {
            const eventStartDate = new Date(event.date);
            eventStartDate.setHours(0, 0, 0, 0);
            
            const eventEndDate = event.endDate ? new Date(event.endDate) : eventStartDate;
            eventEndDate.setHours(0, 0, 0, 0);
            
            return currentDate >= eventStartDate && currentDate <= eventEndDate;
        } catch (error) {
            console.error("Date parsing error:", error);
            return false;
        }
    });
}

   function loadProfileEvents() {
        const profileEventsList = document.getElementById("profileEventsList");
        profileEventsList.innerHTML = "";
        
        if (userEvents.length === 0) {
            profileEventsList.innerHTML = '<div class="empty-state">You haven\'t created any events yet</div>';
            return;
        }
        
        userEvents.forEach(event => {
            const eventElement = document.createElement("div");
            eventElement.classList.add("event-item");
            
            const eventDate = new Date(event.date);
            const formattedDate = eventDate.toLocaleDateString("en-US", {
                weekday: "short",
                year: "numeric",
                month: "short",
                day: "numeric"
            });
            
            eventElement.innerHTML = `
                <div class="event-date">
                    <div class="day">${eventDate.getDate()}</div>
                    <div class="month">${eventDate.toLocaleString('default', { month: 'short' })}</div>
                </div>
                <div class="event-details">
                    <h4>${event.title}</h4>
                    <p>${formattedDate}  ${event.location || 'No location specified'}</p>
                </div>
                <div class="event-category">${event.category}</div>
            `;
            
            profileEventsList.appendChild(eventElement);
        });
    }

    function savePreferences(e) {
        e.preventDefault();
        
        if (currentUser) {
            currentUser.preferences = {
                notifications: document.getElementById("notificationPref").value,
                timezone: document.getElementById("timezonePref").value,
                language: document.getElementById("languagePref").value,
                emailUpdates: document.getElementById("emailUpdates").checked
            };
            
            // Update localStorage if user is remembered
            if (localStorage.getItem('currentUser')) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            
            showNotification("Preferences saved successfully!", "success");
        }
    }

    // Storage functions
    function saveEventsToStorage() {
        localStorage.setItem('userEvents', JSON.stringify(userEvents));
    }
 

function getThisMonthFestivals() {
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    const allEvents = [...events, ...systemEvents];
    
    return allEvents.filter(event => {
        const eventDate = new Date(event.date);
        return (event.category === "festival" || event.eventType === "festival") &&
               eventDate.getMonth() === currentMonth &&
               eventDate.getFullYear() === currentYear;
    });
}

    function getThisMonthFestivals() {
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        return events.filter(event => {
            const eventDate = new Date(event.date);
            return (event.category === "festival" || event.category === "national") &&
                   eventDate.getMonth() === currentMonth &&
                   eventDate.getFullYear() === currentYear;
        });
    }


    // AI Assistant Functions
    function toggleAIChat() {
        const chatContainer = document.getElementById("aiChatContainer");
        chatContainer.classList.toggle("active");
    }

    function sendAIMessage() {
        const input = document.getElementById("aiChatInput");
        const message = input.value.trim();
        
        if (message === "") return;
        
        // Add user message
        addAIMessage(message, "user");
        input.value = "";
        
        // Simulate AI response
        setTimeout(() => {
            const responses = [
                "I can help you schedule events and manage your calendar. What specific event would you like to add?",
                "That's a great event idea! Would you like me to help you set reminders for it?",
                "I notice you have several events coming up. Would you like me to help you organize them?",
                "For optimal event planning, consider adding photos and detailed descriptions to make your events more memorable!",
                "I can help you categorize your events as festivals, national holidays, religious events, or personal occasions."
            ];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addAIMessage(randomResponse, "bot");
        }, 1000);
    }

    function addAIMessage(message, sender) {
        const messagesContainer = document.getElementById("aiChatMessages");
        const messageElement = document.createElement("div");
        messageElement.classList.add("ai-message", `ai-message-${sender}`);
        
        const messageText = document.createElement("p");
        messageText.textContent = message;
        messageElement.appendChild(messageText);
        
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Notification function
    function showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.notification');
        existingNotifications.forEach(notification => {
            notification.remove();
        });

        const notification = document.createElement('div');
        notification.classList.add('notification', type);
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    function debugProfileData() {
    console.log("=== DEBUG PROFILE DATA ===");
    console.log("Current User:", currentUser);
    console.log("Profile First Name Field:", document.getElementById("profileFirstName")?.value);
    console.log("Profile Last Name Field:", document.getElementById("profileLastName")?.value);
    console.log("Profile Email Field:", document.getElementById("profileEmailInput")?.value);
    console.log("Profile Header Name:", document.getElementById("profileName")?.textContent);
    console.log("Profile Header Email:", document.getElementById("profileEmail")?.textContent);
    console.log("===========================");
}

// Call this when loading the profile page
function showProfilePage() {
    if (!isLoggedIn) {
        showNotification("Please log in to view your profile", "warning");
        showLoginPage();
        return;
    }
    
    showPage("profile");
    
    // Force reload profile data every time profile page is opened
    if (currentUser) {
        updateAllProfileData(currentUser);
    }
    
    // Ensure edit profile section is active by default
    showProfileSection('edit-profile');
}

function testDatabaseConnection() {
    if (!currentUser) {
        console.log("Please login first");
        return;
    }
    
    console.log("Testing database connection...");
    
    fetch(`get_events.php?userId=${currentUser.id}`)
    .then(response => response.json())
    .then(data => {
        console.log("Database Response:", data);
        if (data.status === 'success') {
            console.log(" Database connection successful!");
            console.log("Events found:", data.events.length);
            data.events.forEach(event => {
                console.log(`- ${event.title} (${event.date})`);
            });
        } else {
            console.error(" Database error:", data.message);
        }
    })
    .catch(error => {
        console.error(" Connection failed:", error);
    });
}

// Call this after login
// testDatabaseConnection();
// Enhanced event saving with database sync
function saveEventToDatabase(eventData, isUpdate = false) {
    return new Promise((resolve, reject) => {
        const formData = new FormData();
        Object.keys(eventData).forEach(key => {
            formData.append(key, eventData[key]);
        });

        fetch('save_event.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                resolve(data);
            } else {
                reject(new Error(data.message));
            }
        })
        .catch(error => reject(error));
    });
}

// Enhanced save event function
async function saveEvent(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        showLoginPage();
        return;
    }

    const eventData = {
        eventTitle: document.getElementById("eventTitle").value.trim(),
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        startTime: document.getElementById("modalStartTime").value || "09:00",
        endTime: document.getElementById("modalEndTime").value || "17:00",
        eventCategory: document.getElementById("eventCategory").value,
        eventPriority: document.getElementById("eventPriority").value,
        eventDescription: document.getElementById("eventDescription").value.trim(),
        eventLocation: document.getElementById("eventLocation").value.trim(),
        userId: currentUser.id
    };

    // Validation
    if (!eventData.eventTitle) {
        showNotification("Event title is required", "error");
        return;
    }

    const saveBtn = document.querySelector('#eventForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    try {
        // Handle photo upload
        const photoFile = document.getElementById("eventPhoto").files[0];
        if (photoFile) {
            eventData.eventPhoto = photoFile;
        }

        const result = await saveEventToDatabase(eventData);
        
        // Create complete event object
        const newEvent = {
            id: result.eventId,
            title: eventData.eventTitle,
            date: eventData.startDate,
            endDate: eventData.endDate,
            startTime: eventData.startTime,
            endTime: eventData.endTime,
            category: eventData.eventCategory,
            priority: eventData.eventPriority,
            description: eventData.eventDescription,
            location: eventData.eventLocation,
            photo: result.photo_url || '',
            userId: currentUser.id
        };

        // Update local arrays
        await updateLocalEvents(newEvent);
        
        // Update UI
        refreshAllEventDisplays();
        
        // Reset form
        document.getElementById("eventForm").reset();
        document.getElementById("photoPreview").style.display = "none";

        showNotification("Event saved successfully!", "success");
        
        // Auto-switch to My Events page
        setTimeout(() => {
            showPage("my-events");
        }, 1000);

    } catch (error) {
        console.error('Save event error:', error);
        showNotification("Failed to save event: " + error.message, "error");
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// Enhanced modal event saving
async function saveModalEvent(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        return;
    }

    const eventData = {
        eventId: document.getElementById("modalEventId").value || '',
        eventTitle: document.getElementById("modalEventTitle").value.trim(),
        startDate: document.getElementById("modalStartDate").value,
        endDate: document.getElementById("modalEndDate").value,
        startTime: document.getElementById("modalStartTime").value || "09:00",
        endTime: document.getElementById("modalEndTime").value || "17:00",
        eventCategory: document.getElementById("modalEventCategory").value,
        eventPriority: document.getElementById("modalEventPriority").value,
        eventDescription: document.getElementById("modalEventDescription").value.trim(),
        eventLocation: document.getElementById("modalEventLocation").value.trim(),
        userId: currentUser.id
    };

    // Validation
    if (!eventData.eventTitle) {
        showNotification("Event title is required", "error");
        return;
    }

    const saveBtn = document.querySelector('#modalEventForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    try {
        // Handle photo upload
        const photoFile = document.getElementById("modalEventPhoto").files[0];
        if (photoFile) {
            eventData.eventPhoto = photoFile;
        }

        const isUpdate = !!eventData.eventId;
        const result = await saveEventToDatabase(eventData, isUpdate);
        
        // Create complete event object
        const savedEvent = {
            id: result.eventId,
            title: eventData.eventTitle,
            date: eventData.startDate,
            endDate: eventData.endDate,
            startTime: eventData.startTime,
            endTime: eventData.endTime,
            category: eventData.eventCategory,
            priority: eventData.eventPriority,
            description: eventData.eventDescription,
            location: eventData.eventLocation,
            photo: result.photo_url || '',
            userId: currentUser.id
        };

        // Update local arrays
        await updateLocalEvents(savedEvent, isUpdate);
        
        // Update UI
        refreshAllEventDisplays();
        
        // Close modal
        closeEventModal();

        showNotification("Event saved successfully!", "success");

    } catch (error) {
        console.error('Save modal event error:', error);
        showNotification("Failed to save event: " + error.message, "error");
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// Update local events array
function updateLocalEvents(event, isUpdate = false) {
    return new Promise((resolve) => {
        if (isUpdate) {
            const index = userEvents.findIndex(e => e.id == event.id);
            if (index !== -1) {
                userEvents[index] = event;
            }
        } else {
            userEvents.push(event);
        }
        
        // Update combined events array
        events = [...indianFestivals, ...userEvents];
        
        // Save to localStorage as backup
        saveEventsToStorage();
        
        resolve();
    });
}

// Enhanced event loading
async function loadEventsFromDatabase() {
    if (!currentUser) return;
    
    try {
        const response = await fetch(`get_events.php?userId=${currentUser.id}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log("Loaded events from database:", data.events);
            
            // Convert database events to frontend format
            const dbEvents = data.events.map(event => ({
                id: event.id,
                title: event.title,
                date: event.start_date,
                endDate: event.end_date,
                startTime: event.start_time,
                endTime: event.end_time,
                category: event.category,
                priority: event.priority,
                description: event.description,
                location: event.location,
                photo: event.photo,
                userId: event.user_id
            }));
            
            userEvents = dbEvents;
            events = [...indianFestivals, ...userEvents];
            
            // Update localStorage with database events
            saveEventsToStorage();
            
            // Update UI
            refreshAllEventDisplays();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Load events from database error:', error);
        // Fallback to localStorage
        loadEventsFromLocalStorage();
    }
}

// Enhanced delete event function
async function deleteEvent(eventId) {
    if (!confirm("Are you sure you want to delete this event?")) {
        return;
    }

    if (!currentUser) {
        showNotification("Please login to delete events", "error");
        return;
    }

    try {
        const formData = new FormData();
        formData.append('eventId', eventId);
        formData.append('userId', currentUser.id);

        const response = await fetch('delete_event.php', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Remove from user events array
            userEvents = userEvents.filter(event => event.id != eventId);
            
            // Update events array
            events = [...indianFestivals, ...userEvents];

            // Update localStorage
            saveEventsToStorage();

            // Update UI
            refreshAllEventDisplays();

            showNotification("Event deleted successfully!", "success");
        } else {
            showNotification(data.message || "Failed to delete event", "error");
        }
    } catch (error) {
        console.error('Delete event error:', error);
        showNotification("Failed to delete event. Please try again.", "error");
    }
}
// Replace the current event validation and scheduling logic

// INTERVAL SCHEDULING ALGORITHM - CORE FUNCTIONS

// 1. Check for time overlaps between events
function hasTimeOverlap(newEvent, existingEvents) {
    // If no time specified, treat as all-day event and prevent any other events
    if (!newEvent.startTime || !newEvent.endTime) {
        return existingEvents.some(existingEvent => {
            if (newEvent.id && existingEvent.id === newEvent.id) return false;
            return existingEvent.date === newEvent.date;
        });
    }

    const newStart = new Date(`${newEvent.date}T${newEvent.startTime}`);
    const newEnd = new Date(`${newEvent.endDate || newEvent.date}T${newEvent.endTime}`);
    
    return existingEvents.some(existingEvent => {
        // Skip comparison with itself if editing
        if (newEvent.id && existingEvent.id === newEvent.id) return false;
        
        // Skip if different dates
        if (existingEvent.date !== newEvent.date) return false;
        
        // If existing event has no time, it's all-day and blocks everything
        if (!existingEvent.startTime || !existingEvent.endTime) {
            return true;
        }
        
        const existingStart = new Date(`${existingEvent.date}T${existingEvent.startTime}`);
        const existingEnd = new Date(`${existingEvent.endDate || existingEvent.date}T${existingEvent.endTime}`);
        
        // Check for overlap: new event starts before existing ends AND new event ends after existing starts
        return newStart < existingEnd && newEnd > existingStart;
    });
}

// 2. Find optimal time slot using interval partitioning
function findOptimalTimeSlot(event, existingEvents, durationMinutes = 60) {
    const eventDate = event.date;
    
    // Get all events for the same day
    const dayEvents = existingEvents.filter(e => e.date === eventDate);
    
    // If no events exist for this day, suggest morning slot
    if (dayEvents.length === 0) {
        return {
            startTime: '09:00',
            endTime: '10:00',
            suggested: true,
            message: 'Morning slot available'
        };
    }
    
    // Define work day hours
    const workDayStart = new Date(`${eventDate}T09:00`);
    const workDayEnd = new Date(`${eventDate}T18:00`);
    
    // Collect all time slots (occupied periods)
    const occupiedSlots = [];
    
    dayEvents.forEach(dayEvent => {
        if (dayEvent.startTime && dayEvent.endTime) {
            const eventStart = new Date(`${eventDate}T${dayEvent.startTime}`);
            const eventEnd = new Date(`${eventDate}T${dayEvent.endTime}`);
            occupiedSlots.push({ start: eventStart, end: eventEnd });
        } else {
            // All-day event blocks the entire day
            return null;
        }
    });
    
    // If we have all-day events, no slots available
    const hasAllDayEvent = dayEvents.some(event => !event.startTime || !event.endTime);
    if (hasAllDayEvent) {
        return null;
    }
    
    // Sort occupied slots by start time (interval scheduling core)
    occupiedSlots.sort((a, b) => a.start - b.start);
    
    // Find gaps between events using interval partitioning
    const availableSlots = [];
    let currentTime = workDayStart;
    
    for (const slot of occupiedSlots) {
        if (slot.start > currentTime) {
            const gapDuration = (slot.start - currentTime) / (1000 * 60); // minutes
            if (gapDuration >= durationMinutes) {
                availableSlots.push({
                    start: new Date(currentTime),
                    end: slot.start,
                    duration: gapDuration
                });
            }
        }
        currentTime = new Date(Math.max(currentTime.getTime(), slot.end.getTime()));
    }
    
    // Check after last event
    if (currentTime < workDayEnd) {
        const gapDuration = (workDayEnd - currentTime) / (1000 * 60);
        if (gapDuration >= durationMinutes) {
            availableSlots.push({
                start: new Date(currentTime),
                end: workDayEnd,
                duration: gapDuration
            });
        }
    }
    
    // Return the first available gap (earliest possible time)
    if (availableSlots.length > 0) {
        const bestSlot = availableSlots[0];
        const endTime = new Date(bestSlot.start.getTime() + durationMinutes * 60000);
        
        return {
            startTime: formatTimeForInput(bestSlot.start),
            endTime: formatTimeForInput(endTime),
            suggested: true,
            message: `Available slot found (${formatTimeForInput(bestSlot.start)} - ${formatTimeForInput(endTime)})`
        };
    }
    
    return null;
}

// 3. Enhanced event validation with interval scheduling
function validateEventWithScheduling(eventData, isEditing = false) {
    const errors = [];
    
    // Basic validation
    if (!eventData.eventTitle?.trim()) {
        errors.push("Event title is required");
    }
    
    if (!eventData.startDate) {
        errors.push("Start date is required");
    }
    
    if (!eventData.endDate) {
        errors.push("End date is required");
    }
    
    // Date validation
    const startDate = new Date(eventData.startDate);
    const endDate = new Date(eventData.endDate);
    
    if (endDate < startDate) {
        errors.push("End date cannot be before start date");
    }
    
    // Time validation
    if (eventData.startTime && eventData.endTime) {
        const startDateTime = new Date(`${eventData.startDate}T${eventData.startTime}`);
        const endDateTime = new Date(`${eventData.endDate}T${eventData.endTime}`);
        
        if (endDateTime <= startDateTime) {
            errors.push("End time must be after start time");
        }
    }
    
    // INTERVAL SCHEDULING: Check for overlaps
    const userEventsForCheck = userEvents.filter(e => {
        if (!isEditing || e.id !== eventData.eventId) {
            return e.date === eventData.startDate; // Only check same day events
        }
        return false;
    });
    
    const eventForCheck = {
        id: eventData.eventId,
        date: eventData.startDate,
        endDate: eventData.endDate,
        startTime: eventData.startTime,
        endTime: eventData.endTime
    };
    
    if (hasTimeOverlap(eventForCheck, userEventsForCheck)) {
        // Calculate duration for optimal slot finding
        let durationMinutes = 60; // default 1 hour
        if (eventData.startTime && eventData.endTime) {
            const start = new Date(`${eventData.startDate}T${eventData.startTime}`);
            const end = new Date(`${eventData.endDate}T${eventData.endTime}`);
            durationMinutes = (end - start) / (1000 * 60);
        }
        
        const optimalSlot = findOptimalTimeSlot(eventForCheck, userEventsForCheck, durationMinutes);
        if (optimalSlot) {
            errors.push(`Time overlap detected. Suggested slot: ${optimalSlot.startTime} - ${optimalSlot.endTime}`);
        } else {
            errors.push("Time overlap detected and no suitable alternative slot found for this day");
        }
    }
    
    return errors;
}

// 4. Sort events by date (1-31, not random)
function sortEventsByDate(eventsArray) {
    return eventsArray.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateA - dateB; // Ascending order (1-31)
    });
}

// 5. Sort events with time consideration
function sortEventsByDateTime(eventsArray) {
    return eventsArray.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        
        // First sort by date
        if (dateA.getTime() !== dateB.getTime()) {
            return dateA - dateB;
        }
        
        // Then sort by start time (all-day events first, then by time)
        if (!a.startTime && b.startTime) return -1;
        if (a.startTime && !b.startTime) return 1;
        if (!a.startTime && !b.startTime) return 0;
        
        return a.startTime.localeCompare(b.startTime);
    });
}

// APPLY INTERVAL SCHEDULING TO ALL PAGES


// 2. CALENDAR - Apply interval scheduling visualization
function renderCalendarWithScheduling() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    currentMonthElement.textContent = `${currentDate.toLocaleString("default", { month: "long" })} ${year}`;
    calendarGrid.innerHTML = "";

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Empty cells for days before first day
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement("div");
        emptyDay.classList.add("calendar-day", "empty-day");
        emptyDay.innerHTML = '<div class="empty-state"> </div>';
        calendarGrid.appendChild(emptyDay);
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement("div");
        dayElement.classList.add("calendar-day");

        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const currentDay = new Date(dateStr);
        currentDay.setHours(0, 0, 0, 0);
        
        if (currentDay.getTime() === today.getTime()) {
            dayElement.classList.add("today");
        }

        // Get and sort events for this day
        const dayEvents = sortEventsByDateTime(getEventsForDate(dateStr));
        
        // Check for scheduling conflicts
        const userDayEvents = dayEvents.filter(event => !event.isSystemEvent);
        const hasConflicts = checkDayForConflicts(userDayEvents);
        
        if (hasConflicts) {
            dayElement.classList.add("has-conflicts");
            dayElement.style.borderLeft = "4px solid var(--danger)";
        }

        // Day header
        const dayHeader = document.createElement("div");
        dayHeader.classList.add("day-header");

        const dayNumber = document.createElement("span");
        dayNumber.classList.add("day-number");
        dayNumber.textContent = day;

        // Conflict indicator
        if (hasConflicts) {
            const conflictBadge = document.createElement("span");
            conflictBadge.classList.add("conflict-badge");
            conflictBadge.innerHTML = " ";
            conflictBadge.title = "Scheduling conflicts detected";
            conflictBadge.style.marginLeft = "5px";
            conflictBadge.style.fontSize = "0.7em";
            dayNumber.appendChild(conflictBadge);
        }

        const addButton = document.createElement("button");
        addButton.classList.add("add-event-btn");
        addButton.innerHTML = "<i class='fas fa-plus'></i>";
        addButton.title = "Add Event on " + dateStr;
        addButton.addEventListener("click", (e) => {
            e.stopPropagation();
            openAddEventModal(dateStr);
        });

        dayHeader.appendChild(dayNumber);
        dayHeader.appendChild(addButton);
        dayElement.appendChild(dayHeader);

        // Event count badge
        if (dayEvents.length > 0) {
            const eventCount = document.createElement("div");
            eventCount.classList.add("event-count");
            eventCount.textContent = dayEvents.length;
            eventCount.title = `${dayEvents.length} events`;
            dayElement.appendChild(eventCount);
        }

        // Events container with sorted events
        const eventsContainer = document.createElement("div");
        eventsContainer.classList.add("events-container");

        if (dayEvents.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.classList.add("empty-state");
            emptyState.textContent = "No events";
            eventsContainer.appendChild(emptyState);
        } else {
            dayEvents.forEach(event => {
                const eventElement = document.createElement("div");
                const isSystemEvent = event.isSystemEvent;
                
                eventElement.classList.add("event", `event-${event.category || 'personal'}`);
                if (isSystemEvent) {
                    eventElement.classList.add('system-event');
                }
                
                // Conflict styling for overlapping user events
                if (isEventInConflict(event, userDayEvents)) {
                    eventElement.classList.add("conflict-event");
                    eventElement.style.borderLeft = "3px solid var(--danger)";
                }
                
                eventElement.title = `${event.title} - ${event.startTime ? formatTime(event.startTime) + ' - ' + formatTime(event.endTime) : 'All Day'}`;
                eventElement.style.cursor = "pointer";

                const eventIcon = document.createElement("i");
                eventIcon.className = getEventIcon(event.category, isSystemEvent);
                eventIcon.style.marginRight = "5px";

                const eventTitle = document.createElement("span");
                let displayText = event.title || "Untitled Event";
                if (event.startTime) {
                    displayText = `${formatTime(event.startTime)} ${displayText}`;
                }
                eventTitle.textContent = displayText;

                eventElement.appendChild(eventIcon);
                eventElement.appendChild(eventTitle);

                if (isSystemEvent) {
                    const systemBadge = document.createElement("span");
                    systemBadge.classList.add("system-badge");
                    systemBadge.innerHTML = " ";
                    systemBadge.title = "System Event";
                    systemBadge.style.marginLeft = "5px";
                    systemBadge.style.fontSize = "0.7em";
                    eventElement.appendChild(systemBadge);
                }

                eventElement.addEventListener("click", (e) => {
                    e.stopPropagation();
                    openEventDetails(event);
                });

                eventsContainer.appendChild(eventElement);
            });
        }

        dayElement.appendChild(eventsContainer);
        calendarGrid.appendChild(dayElement);
    }
}

// 3. ADD EVENT - Apply interval scheduling validation
function saveEventWithScheduling(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        showLoginPage();
        return;
    }

    const eventData = {
        eventTitle: document.getElementById("eventTitle").value.trim(),
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        startTime: document.getElementById("modalStartTime").value,
        endTime: document.getElementById("modalEndTime").value,
        eventCategory: document.getElementById("eventCategory").value,
        eventPriority: document.getElementById("eventPriority").value,
        eventDescription: document.getElementById("eventDescription").value.trim(),
        eventLocation: document.getElementById("eventLocation").value.trim(),
        userId: currentUser.id
    };

    // INTERVAL SCHEDULING VALIDATION
    const validationErrors = validateEventWithScheduling(eventData);
    if (validationErrors.length > 0) {
        const errorMessage = validationErrors.join(". ");
        showNotification(errorMessage, "error");
        
        // Auto-suggest optimal time slot
        const suggestedMatch = validationErrors.find(err => err.includes('Suggested slot:'));
        if (suggestedMatch) {
            const suggestedTime = suggestedMatch.split('Suggested slot: ')[1];
            if (confirm(`Would you like to use the suggested time slot: ${suggestedTime}?`)) {
                const [startTime, endTime] = suggestedTime.split(' - ');
                document.getElementById("modalStartTime").value = startTime;
                document.getElementById("modalEndTime").value = endTime;
                setTimeout(() => saveEventWithScheduling(e), 100);
            }
        }
        return;
    }

    const saveBtn = document.querySelector('#eventForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    // Simulate save
    setTimeout(() => {
        const newEvent = {
            id: Date.now(),
            title: eventData.eventTitle,
            date: eventData.startDate,
            endDate: eventData.endDate,
            startTime: eventData.startTime,
            endTime: eventData.endTime,
            category: eventData.eventCategory,
            priority: eventData.eventPriority,
            description: eventData.eventDescription,
            location: eventData.eventLocation,
            userId: currentUser.id,
            isSystemEvent: false
        };

        // Add to user events
        userEvents.push(newEvent);
        
        // Update combined events with sorting
        events = sortEventsByDate([...systemEvents, ...userEvents]);
        
        // Save to storage
        saveEventsToStorage();
        
        // Update ALL displays
        refreshAllEventDisplays();
        
        // Reset form
        document.getElementById("eventForm").reset();
        document.getElementById("photoPreview").style.display = "none";

        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;

        showNotification("Event saved successfully with optimal scheduling! ", "success");
        
        setTimeout(() => {
            showPage("my-events");
        }, 1000);
    }, 1000);
}

// 4. MY EVENTS - Apply interval scheduling and proper sorting
function loadUserEvents() {
    const userEventsList = document.getElementById("userEventsList");
    if (!userEventsList) return;
    
    userEventsList.innerHTML = "";
    
    if (!currentUser) {
        userEventsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                Please log in to view your events
            </div>
        `;
        return;
    }
    
    // Sort user events by date (1-31)
    const userSpecificEvents = sortEventsByDate(userEvents.filter(event => 
        event.userId === currentUser.id
    ));
    
    if (userSpecificEvents.length === 0) {
        userEventsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-plus"></i>
                You haven't created any events yet. 
                <br><small>Click "Add Event" to create your first event!</small>
            </div>
        `;
        return;
    }
    
    userSpecificEvents.forEach(event => {
        const eventElement = document.createElement("div");
        eventElement.classList.add("event-item");
        
        // Format date
        let formattedDate = "Date not set";
        let day = "?";
        let month = "???";
        
        try {
            const eventDate = new Date(event.date);
            if (!isNaN(eventDate.getTime())) {
                formattedDate = eventDate.toLocaleDateString("en-US", {
                    weekday: "short",
                    year: "numeric",
                    month: "short",
                    day: "numeric"
                });
                day = eventDate.getDate();
                month = eventDate.toLocaleString('default', { month: 'short' });
            }
        } catch (error) {
            console.error("Date formatting error:", error);
        }
        
        const startTime = event.startTime ? formatTime(event.startTime) : 'All Day';
        const endTime = event.endTime ? formatTime(event.endTime) : '';
        const timeDisplay = endTime ? `${startTime} - ${endTime}` : startTime;
        
        eventElement.innerHTML = `
            <div class="event-date">
                <div class="day">${day}</div>
                <div class="month">${month}</div>
            </div>
            <div class="event-details">
                <h4>${event.title || "Untitled Event"}</h4>
                <p><i class="fas fa-calendar"></i> ${formattedDate}</p>
                <p><i class="fas fa-clock"></i> ${timeDisplay}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${event.location || 'No location specified'}</p>
                <small>${event.description || 'No description provided'}</small>
            </div>
            <div class="event-category ${event.category}">
                ${event.category.charAt(0).toUpperCase() + event.category.slice(1)}
            </div>
            <button class="btn btn-danger btn-sm" onclick="deleteEvent(${event.id})" title="Delete Event">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        userEventsList.appendChild(eventElement);
    });
}

// HELPER FUNCTIONS FOR INTERVAL SCHEDULING

function checkDayForConflicts(dayEvents) {
    if (dayEvents.length < 2) return false;
    
    const userEvents = dayEvents.filter(event => !event.isSystemEvent);
    
    for (let i = 0; i < userEvents.length; i++) {
        for (let j = i + 1; j < userEvents.length; j++) {
            if (hasTimeOverlap(userEvents[i], [userEvents[j]])) {
                return true;
            }
        }
    }
    return false;
}

function isEventInConflict(targetEvent, dayEvents) {
    if (!targetEvent.startTime || !targetEvent.endTime) return false;
    
    const otherEvents = dayEvents.filter(event => 
        event.id !== targetEvent.id && !event.isSystemEvent
    );
    
    return hasTimeOverlap(targetEvent, otherEvents);
}

function formatTimeForInput(date) {
    return date.toTimeString().slice(0, 5);
}

// REPLACE ORIGINAL FUNCTIONS WITH SCHEDULING VERSIONS

// Replace original functions with scheduling versions
saveEvent = saveEventWithScheduling;
renderCalendar = renderCalendarWithScheduling;

// Update modal event saving too
const originalSaveModalEvent = saveModalEvent;
saveModalEvent = function(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        return;
    }

    const eventData = {
        eventId: document.getElementById("modalEventId").value || '',
        eventTitle: document.getElementById("modalEventTitle").value.trim(),
        startDate: document.getElementById("modalStartDate").value,
        endDate: document.getElementById("modalEndDate").value,
        startTime: document.getElementById("modalStartTime").value,
        endTime: document.getElementById("modalEndTime").value,
        eventCategory: document.getElementById("modalEventCategory").value,
        eventPriority: document.getElementById("modalEventPriority").value,
        eventDescription: document.getElementById("modalEventDescription").value.trim(),
        eventLocation: document.getElementById("modalEventLocation").value.trim(),
        userId: currentUser.id
    };

    // Apply interval scheduling validation to modal too
    const validationErrors = validateEventWithScheduling(eventData, !!eventData.eventId);
    if (validationErrors.length > 0) {
        const errorMessage = validationErrors.join(". ");
        showNotification(errorMessage, "error");
        return;
    }

    // Continue with original modal save logic...
    return originalSaveModalEvent.call(this, e);
};

console.log(" Interval Scheduling Algorithm applied to ALL pages!");
console.log(" Dashboard - Events sorted 31-1, conflict detection");
console.log(" Calendar - Time-based event display, conflict visualization");
console.log(" Add Event - Overlap prevention, optimal slot suggestions");
console.log(" My Events - Proper date sorting 1-31");
console.log(" Upcoming Events - Chronological order 1-31");


// ONE EVENT PER DATE SYSTEM - CORE FUNCTIONS

// 1. Check if date is already occupied
function isDateOccupied(dateStr, editingEventId = null) {
    // Check both user events and system events
    const allEvents = [...userEvents, ...systemEvents];
    
    return allEvents.some(event => {
        // Skip the event we're editing
        if (editingEventId && event.id === editingEventId) return false;
        
        // Check if this event occupies the target date
        const eventStartDate = new Date(event.date);
        const eventEndDate = event.endDate ? new Date(event.endDate) : eventStartDate;
        const targetDate = new Date(dateStr);
        
        // Set all dates to start of day for comparison
        eventStartDate.setHours(0, 0, 0, 0);
        eventEndDate.setHours(0, 0, 0, 0);
        targetDate.setHours(0, 0, 0, 0);
        
        return targetDate >= eventStartDate && targetDate <= eventEndDate;
    });
}

// 2. Sort events by date (newest first)
function sortEventsNewestFirst(eventsArray) {
    return eventsArray.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA; // Descending order (newest first)
    });
}

// 3. Sort events by date (oldest first) for calendar
function sortEventsOldestFirst(eventsArray) {
    return eventsArray.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateA - dateB; // Ascending order (oldest first)
    });
}

// 4. Enhanced event validation - ONE EVENT PER DATE
function validateEventOnePerDate(eventData, isEditing = false) {
    const errors = [];
    
    // Basic validation
    if (!eventData.eventTitle?.trim()) {
        errors.push("Event title is required");
    }
    
    if (!eventData.startDate) {
        errors.push("Start date is required");
    }
    
    if (!eventData.endDate) {
        errors.push("End date is required");
    }
    
    // Date validation
    const startDate = new Date(eventData.startDate);
    const endDate = new Date(eventData.endDate);
    
    if (endDate < startDate) {
        errors.push("End date cannot be before start date");
    }
    
    // ONE EVENT PER DATE VALIDATION
    const startDateStr = eventData.startDate;
    const endDateStr = eventData.endDate || eventData.startDate;
    
    // Check all dates in the range
    const start = new Date(startDateStr);
    const end = new Date(endDateStr);
    
    for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
        const dateStr = date.toISOString().split('T')[0];
        
        if (isDateOccupied(dateStr, isEditing ? eventData.eventId : null)) {
            // Find which event is occupying this date
            const allEvents = [...userEvents, ...systemEvents];
            const occupyingEvent = allEvents.find(event => {
                if (isEditing && event.id === eventData.eventId) return false;
                
                const eventStart = new Date(event.date);
                const eventEnd = event.endDate ? new Date(event.endDate) : eventStart;
                const checkDate = new Date(dateStr);
                
                eventStart.setHours(0, 0, 0, 0);
                eventEnd.setHours(0, 0, 0, 0);
                checkDate.setHours(0, 0, 0, 0);
                
                return checkDate >= eventStart && checkDate <= eventEnd;
            });
            
            const eventName = occupyingEvent ? occupyingEvent.title : 'Another event';
            errors.push(`Date ${dateStr} is already occupied by "${eventName}"`);
            break; // Stop at first conflict
        }
    }
    
    return errors;
}

// 5. Get unique events (remove duplicates)
function getUniqueEvents(eventsArray) {
    const uniqueDates = new Set();
    const uniqueEvents = [];
    
    eventsArray.forEach(event => {
        const dateKey = event.date; // Use date as unique key
        
        if (!uniqueDates.has(dateKey)) {
            uniqueDates.add(dateKey);
            uniqueEvents.push(event);
        }
    });
    
    return uniqueEvents;
}

// 6. Get events for date (only one event per date)
function getEventForDate(dateStr) {
    const allEvents = [...userEvents, ...systemEvents];
    
    // Find the first event that occupies this date
    const event = allEvents.find(event => {
        const eventStartDate = new Date(event.date);
        const eventEndDate = event.endDate ? new Date(event.endDate) : eventStartDate;
        const targetDate = new Date(dateStr);
        
        // Set all dates to start of day for comparison
        eventStartDate.setHours(0, 0, 0, 0);
        eventEndDate.setHours(0, 0, 0, 0);
        targetDate.setHours(0, 0, 0, 0);
        
        return targetDate >= eventStartDate && targetDate <= eventEndDate;
    });
    
    return event || null; // Return null if no event found
}

// APPLY ONE EVENT PER DATE TO ALL PAGES

// 1. FIXED GET UPCOMING EVENTS FUNCTION
function getUpcomingEvents() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Get all unique events (user + system)
    const allEvents = getUniqueEvents([...userEvents, ...systemEvents]);
    
    const upcoming = allEvents.filter(event => {
        try {
            const eventDate = new Date(event.date);
            eventDate.setHours(0, 0, 0, 0);
            return eventDate >= today;
        } catch (error) {
            return false;
        }
    });
    
    // Sort by date (ascending - closest first)
    return upcoming.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateA - dateB;
    }).slice(0, 8);
}

// 2. FIXED UPDATE UPCOMING EVENTS LIST
function updateUpcomingEventsList() {
    const upcomingEventsList = document.getElementById("upcomingEventsList");
    if (!upcomingEventsList) return;
    
    upcomingEventsList.innerHTML = "";
    const upcomingEvents = getUpcomingEvents();
    
    if (upcomingEvents.length === 0) {
        upcomingEventsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-plus"></i>
                No upcoming events. Add some events to see them here!
            </div>
        `;
        return;
    }
    
    upcomingEvents.forEach(event => {
        const eventElement = document.createElement("div");
        eventElement.classList.add("event-item");
        eventElement.style.cursor = "pointer";
        
        // Format date
        let formattedDate = "Date not set";
        let day = "?";
        let month = "???";
        
        try {
            const eventDate = new Date(event.date);
            if (!isNaN(eventDate.getTime())) {
                formattedDate = eventDate.toLocaleDateString("en-US", {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric"
                });
                day = eventDate.getDate();
                month = eventDate.toLocaleString('default', { month: 'short' });
            }
        } catch (error) {
            console.error("Date formatting error:", error);
        }
        
        const isSystemEvent = event.isSystemEvent;
        
        eventElement.innerHTML = `
            <div class="event-date">
                <div class="day">${day}</div>
                <div class="month">${month}</div>
            </div>
            <div class="event-details">
                <h4>${event.title || "Untitled Event"} ${isSystemEvent ? '' : ''}</h4>
                <p><i class="fas fa-calendar"></i> ${formattedDate}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${event.location || 'No location specified'}</p>
                <small>${event.description || 'No description provided'}</small>
            </div>
            <div class="event-category ${event.category || 'personal'}">
                ${(event.category || 'personal').charAt(0).toUpperCase() + (event.category || 'personal').slice(1)}
                ${isSystemEvent ? ' ' : ''}
            </div>
        `;
        
        eventElement.addEventListener("click", () => {
            openEventDetails(event);
        });
        
        upcomingEventsList.appendChild(eventElement);
    });
}

// 3. FIXED REFRESH FUNCTION
function refreshAllEventDisplays() {
    updateDashboard(); // This includes upcoming events
    renderCalendar();
    loadUserEvents();
}

// 4. FIXED SAVE EVENT FUNCTION
function saveEventOnePerDate(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        showLoginPage();
        return;
    }

    const eventData = {
        eventTitle: document.getElementById("eventTitle").value.trim(),
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        startTime: document.getElementById("modalStartTime").value,
        endTime: document.getElementById("modalEndTime").value,
        eventCategory: document.getElementById("eventCategory").value,
        eventPriority: document.getElementById("eventPriority").value,
        eventDescription: document.getElementById("eventDescription").value.trim(),
        eventLocation: document.getElementById("eventLocation").value.trim(),
        userId: currentUser.id
    };

    // STRICT ONE EVENT PER DATE VALIDATION
    const validationErrors = validateEventOnePerDate(eventData);
    if (validationErrors.length > 0) {
        const errorMessage = validationErrors.join(". ");
        showNotification(errorMessage, "error");
        return;
    }

    const saveBtn = document.querySelector('#eventForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    // Simulate save
    setTimeout(() => {
        const newEvent = {
            id: Date.now(),
            title: eventData.eventTitle,
            date: eventData.startDate,
            endDate: eventData.endDate,
            startTime: eventData.startTime,
            endTime: eventData.endTime,
            category: eventData.eventCategory,
            priority: eventData.eventPriority,
            description: eventData.eventDescription,
            location: eventData.eventLocation,
            userId: currentUser.id,
            isSystemEvent: false
        };

        // Add to user events
        userEvents.push(newEvent);
        
        // Update combined events with unique sorting
        events = getUniqueEvents(sortEventsNewestFirst([...systemEvents, ...userEvents]));
        
        // Save to storage
        saveEventsToStorage();
        
        // Update ALL displays
        refreshAllEventDisplays();
        
        // Reset form
        document.getElementById("eventForm").reset();
        document.getElementById("photoPreview").style.display = "none";

        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;

        showNotification("Event saved successfully! ", "success");
        
        // Auto switch to dashboard to see upcoming events
        setTimeout(() => {
            showPage("dashboard");
        }, 1000);
    }, 1000);
}

// 5. FIXED DASHBOARD FUNCTION
function updateDashboard() {
    // Get unique events (no duplicates) and sort newest first
    const allUniqueEvents = getUniqueEvents(sortEventsNewestFirst([...userEvents, ...systemEvents]));
    
    // Update stats
    document.getElementById("totalEvents").textContent = allUniqueEvents.length;
    document.getElementById("upcomingEvents").textContent = getUpcomingEvents().length;
    document.getElementById("festivalsCount").textContent = getThisMonthFestivals().length;
    document.getElementById("activeUsers").textContent = isLoggedIn ? "1" : "0";

    // Update upcoming events list
    updateUpcomingEventsList();
}

// REPLACE THE FUNCTIONS
saveEvent = saveEventOnePerDate;
// 2. CALENDAR - Show only one event per date
function renderCalendarOnePerDate() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    currentMonthElement.textContent = `${currentDate.toLocaleString("default", { month: "long" })} ${year}`;
    calendarGrid.innerHTML = "";

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Empty cells for days before first day
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement("div");
        emptyDay.classList.add("calendar-day", "empty-day");
        emptyDay.innerHTML = '<div class="empty-state"> </div>';
        calendarGrid.appendChild(emptyDay);
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement("div");
        dayElement.classList.add("calendar-day");

        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const currentDay = new Date(dateStr);
        currentDay.setHours(0, 0, 0, 0);
        
        if (currentDay.getTime() === today.getTime()) {
            dayElement.classList.add("today");
        }

        // Get ONLY ONE event for this date
        const dayEvent = getEventForDate(dateStr);
        const isDateOccupiedFlag = !!dayEvent;

        // Day header
        const dayHeader = document.createElement("div");
        dayHeader.classList.add("day-header");

        const dayNumber = document.createElement("span");
        dayNumber.classList.add("day-number");
        dayNumber.textContent = day;

        // Occupied date indicator
        if (isDateOccupiedFlag) {
            const occupiedBadge = document.createElement("span");
            occupiedBadge.classList.add("occupied-badge");
            occupiedBadge.innerHTML = " ";
            occupiedBadge.title = "Date occupied - Cannot add new events";
            occupiedBadge.style.marginLeft = "5px";
            occupiedBadge.style.fontSize = "0.7em";
            dayNumber.appendChild(occupiedBadge);
        }

        const addButton = document.createElement("button");
        addButton.classList.add("add-event-btn");
        addButton.innerHTML = "<i class='fas fa-plus'></i>";
        addButton.title = isDateOccupiedFlag ? "Date occupied - Cannot add events" : "Add Event on " + dateStr;
        
        // DISABLE add button if date is occupied
        if (isDateOccupiedFlag) {
            addButton.disabled = true;
            addButton.style.opacity = "0.3";
            addButton.style.cursor = "not-allowed";
        } else {
            addButton.addEventListener("click", (e) => {
                e.stopPropagation();
                openAddEventModal(dateStr);
            });
        }

        dayHeader.appendChild(dayNumber);
        dayHeader.appendChild(addButton);
        dayElement.appendChild(dayHeader);

        // Events container - ONLY ONE EVENT
        const eventsContainer = document.createElement("div");
        eventsContainer.classList.add("events-container");

        if (!dayEvent) {
            const emptyState = document.createElement("div");
            emptyState.classList.add("empty-state");
            emptyState.textContent = "No events";
            eventsContainer.appendChild(emptyState);
        } else {
            const eventElement = document.createElement("div");
            const isSystemEvent = dayEvent.isSystemEvent;
            
            eventElement.classList.add("event", `event-${dayEvent.category || 'personal'}`);
            if (isSystemEvent) {
                eventElement.classList.add('system-event');
            }
            
            eventElement.title = `${dayEvent.title} - Click for details`;
            eventElement.style.cursor = "pointer";

            const eventIcon = document.createElement("i");
            eventIcon.className = getEventIcon(dayEvent.category, isSystemEvent);
            eventIcon.style.marginRight = "5px";

            const eventTitle = document.createElement("span");
            eventTitle.textContent = dayEvent.title || "Untitled Event";

            eventElement.appendChild(eventIcon);
            eventElement.appendChild(eventTitle);

            if (isSystemEvent) {
                const systemBadge = document.createElement("span");
                systemBadge.classList.add("system-badge");
                systemBadge.innerHTML = " ";
                systemBadge.title = "System Event";
                systemBadge.style.marginLeft = "5px";
                systemBadge.style.fontSize = "0.7em";
                eventElement.appendChild(systemBadge);
            }

            eventElement.addEventListener("click", (e) => {
                e.stopPropagation();
                openEventDetails(dayEvent);
            });

            eventsContainer.appendChild(eventElement);
        }

        dayElement.appendChild(eventsContainer);
        calendarGrid.appendChild(dayElement);
    }
}


// 4. MY EVENTS - Show unique user events sorted newest first
function loadUserEvents() {
    const userEventsList = document.getElementById("userEventsList");
    if (!userEventsList) return;
    
    userEventsList.innerHTML = "";
    
    if (!currentUser) {
        userEventsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                Please log in to view your events
            </div>
        `;
        return;
    }
    
    // Get unique user events sorted newest first
    const userSpecificEvents = getUniqueEvents(sortEventsNewestFirst(userEvents.filter(event => 
        event.userId === currentUser.id
    )));
    
    if (userSpecificEvents.length === 0) {
        userEventsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-calendar-plus"></i>
                You haven't created any events yet. 
                <br><small>Click "Add Event" to create your first event!</small>
            </div>
        `;
        return;
    }
    
    userSpecificEvents.forEach(event => {
        const eventElement = document.createElement("div");
        eventElement.classList.add("event-item");
        
        // Format date
        let formattedDate = "Date not set";
        let day = "?";
        let month = "???";
        
        try {
            const eventDate = new Date(event.date);
            if (!isNaN(eventDate.getTime())) {
                formattedDate = eventDate.toLocaleDateString("en-US", {
                    weekday: "short",
                    year: "numeric",
                    month: "short",
                    day: "numeric"
                });
                day = eventDate.getDate();
                month = eventDate.toLocaleString('default', { month: 'short' });
            }
        } catch (error) {
            console.error("Date formatting error:", error);
        }
        
        const startTime = event.startTime ? formatTime(event.startTime) : 'All Day';
        const endTime = event.endTime ? formatTime(event.endTime) : '';
        const timeDisplay = endTime ? `${startTime} - ${endTime}` : startTime;
        
        eventElement.innerHTML = `
            <div class="event-date">
                <div class="day">${day}</div>
                <div class="month">${month}</div>
            </div>
            <div class="event-details">
                <h4>${event.title || "Untitled Event"}</h4>
                <p><i class="fas fa-calendar"></i> ${formattedDate}</p>
                <p><i class="fas fa-clock"></i> ${timeDisplay}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${event.location || 'No location specified'}</p>
                <small>${event.description || 'No description provided'}</small>
            </div>
            <div class="event-category ${event.category}">
                ${event.category.charAt(0).toUpperCase() + event.category.slice(1)}
            </div>
            <button class="btn btn-danger btn-sm" onclick="deleteEvent(${event.id})" title="Delete Event">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        userEventsList.appendChild(eventElement);
    });
}

// 5. Update modal to check date availability
function openAddEventModal(dateStr) {
    if (!isLoggedIn) {
        showNotification("Please login to add events", "warning");
        showLoginPage();
        return;
    }

    // CHECK IF DATE IS ALREADY OCCUPIED
    if (isDateOccupied(dateStr)) {
        const occupyingEvent = getEventForDate(dateStr);
        const eventName = occupyingEvent ? occupyingEvent.title : 'an event';
        showNotification(`Cannot add event - ${dateStr} is already occupied by "${eventName}"`, "error");
        return;
    }

    selectedDate = dateStr;
    editingEventId = null;

    // Reset and populate the modal form
    document.getElementById("modalEventForm").reset();
    document.getElementById("modalSelectedDate").value = dateStr;
    document.getElementById("modalEventId").value = "";
    document.getElementById("modalTitle").textContent = "Add New Event";
    
    // Set the dates to the selected date
    document.getElementById("modalStartDate").value = dateStr;
    document.getElementById("modalEndDate").value = dateStr;
    
    // Set default times
    document.getElementById("modalStartTime").value = "09:00";
    document.getElementById("modalEndTime").value = "17:00";
    
    // Set default category and priority
    document.getElementById("modalEventCategory").value = "personal";
    document.getElementById("modalEventPriority").value = "medium";
    
    // Clear photo preview
    document.getElementById("modalPhotoPreview").style.display = "none";
    document.getElementById("modalEventPhoto").value = "";

    // Show the modal
    eventModal.style.display = "flex";
}

// REPLACE ORIGINAL FUNCTIONS

// Replace original functions with one-event-per-date versions
saveEvent = saveEventOnePerDate;
renderCalendar = renderCalendarOnePerDate;

// Update modal event saving too
saveModalEvent = function(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        return;
    }

    const eventData = {
        eventId: document.getElementById("modalEventId").value || '',
        eventTitle: document.getElementById("modalEventTitle").value.trim(),
        startDate: document.getElementById("modalStartDate").value,
        endDate: document.getElementById("modalEndDate").value,
        startTime: document.getElementById("modalStartTime").value,
        endTime: document.getElementById("modalEndTime").value,
        eventCategory: document.getElementById("modalEventCategory").value,
        eventPriority: document.getElementById("modalEventPriority").value,
        eventDescription: document.getElementById("modalEventDescription").value.trim(),
        eventLocation: document.getElementById("modalEventLocation").value.trim(),
        userId: currentUser.id
    };

    // Apply one-event-per-date validation to modal too
    const validationErrors = validateEventOnePerDate(eventData, !!eventData.eventId);
    if (validationErrors.length > 0) {
        const errorMessage = validationErrors.join(". ");
        showNotification(errorMessage, "error");
        return;
    }

    // Continue with modal save logic...
    const saveBtn = document.querySelector('#modalEventForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    setTimeout(() => {
        const newEvent = {
            id: eventData.eventId || Date.now(),
            title: eventData.eventTitle,
            date: eventData.startDate,
            endDate: eventData.endDate,
            startTime: eventData.startTime,
            endTime: eventData.endTime,
            category: eventData.eventCategory,
            priority: eventData.eventPriority,
            description: eventData.eventDescription,
            location: eventData.eventLocation,
            userId: currentUser.id,
            isSystemEvent: false
        };

        // Update or add event
        const existingIndex = userEvents.findIndex(e => e.id == eventData.eventId);
        if (existingIndex >= 0) {
            userEvents[existingIndex] = newEvent;
        } else {
            userEvents.push(newEvent);
        }

        // Update combined events with unique sorting
        events = getUniqueEvents(sortEventsNewestFirst([...systemEvents, ...userEvents]));
        
        // Save to storage
        saveEventsToStorage();
        
        // Update ALL displays
        refreshAllEventDisplays();
        
        // Close modal
        closeEventModal();

        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;

        showNotification("Event saved successfully!", "success");
    }, 1000);
};

// Add CSS for occupied dates
const occupiedStyles = `
<style>
.occupied-badge {
    color: #dc3545;
    font-weight: bold;
}

.calendar-day .add-event-btn:disabled {
    cursor: not-allowed !important;
    opacity: 0.3 !important;
}

.calendar-day .add-event-btn:disabled:hover {
    transform: none !important;
    background: var(--primary) !important;
}

.date-occupied {
    background: linear-gradient(135deg, #ffe6e6 0%, #ffffff 50%) !important;
    border-left: 4px solid #dc3545 !important;
}
</style>
`;

// Add the styles to the document
document.head.insertAdjacentHTML('beforeend', occupiedStyles);

console.log(" ONE EVENT PER DATE SYSTEM ACTIVATED!");
console.log(" Only one event allowed per date");
console.log(" Events sorted newest first (31-1)");
console.log(" Duplicate events automatically removed");
console.log(" Occupied dates blocked from new events");
console.log(" Add button disabled for occupied dates");
// Find optimal time slot using interval partitioning
function findOptimalTimeSlot(event, existingEvents, durationMinutes = 60) {
    const eventDate = event.date;
    const workDayStart = new Date(`${eventDate}T09:00`);
    const workDayEnd = new Date(`${eventDate}T18:00`);
    
    // Get all events for the same day (user events only, not system events)
    const dayEvents = existingEvents.filter(e => 
        e.date === eventDate && !e.isSystemEvent
    );
    
    if (dayEvents.length === 0) {
        return {
            startTime: '09:00',
            endTime: '10:00',
            suggested: true
        };
    }
    
    // Sort events by start time
    const sortedEvents = dayEvents.sort((a, b) => {
        const timeA = a.startTime || '00:00';
        const timeB = b.startTime || '00:00';
        return timeA.localeCompare(timeB);
    });
    
    // Find gaps between events
    const gaps = [];
    let currentTime = workDayStart;
    
    for (const dayEvent of sortedEvents) {
        const eventStart = new Date(`${eventDate}T${dayEvent.startTime || '00:00'}`);
        
        if (eventStart > currentTime) {
            const gapDuration = (eventStart - currentTime) / (1000 * 60); // gap in minutes
            if (gapDuration >= durationMinutes) {
                gaps.push({
                    start: new Date(currentTime),
                    end: eventStart,
                    duration: gapDuration
                });
            }
        }
        
        const eventEnd = new Date(`${eventDate}T${dayEvent.endTime || '23:59'}`);
        currentTime = new Date(Math.max(currentTime.getTime(), eventEnd.getTime()));
    }
    
    // Check after last event
    if (currentTime < workDayEnd) {
        const gapDuration = (workDayEnd - currentTime) / (1000 * 60);
        if (gapDuration >= durationMinutes) {
            gaps.push({
                start: new Date(currentTime),
                end: workDayEnd,
                duration: gapDuration
            });
        }
    }
    
    // Return the first available gap, or null if no suitable gap found
    if (gaps.length > 0) {
        const bestGap = gaps[0]; // First available gap (earliest)
        return {
            startTime: formatTimeForInput(bestGap.start),
            endTime: formatTimeForInput(new Date(bestGap.start.getTime() + durationMinutes * 60000)),
            suggested: true
        };
    }
    
    return null;
}

function formatTimeForInput(date) {
    return date.toTimeString().slice(0, 5);
}

// Enhanced event validation with overlap checking
function validateEvent(eventData, isEditing = false) {
    const errors = [];
    
    // Basic validation
    if (!eventData.eventTitle?.trim()) {
        errors.push("Event title is required");
    }
    
    if (!eventData.startDate) {
        errors.push("Start date is required");
    }
    
    if (!eventData.endDate) {
        errors.push("End date is required");
    }
    
    // Date validation
    const startDate = new Date(eventData.startDate);
    const endDate = new Date(eventData.endDate);
    
    if (endDate < startDate) {
        errors.push("End date cannot be before start date");
    }
    
    // Time validation
    if (eventData.startTime && eventData.endTime) {
        const startDateTime = new Date(`${eventData.startDate}T${eventData.startTime}`);
        const endDateTime = new Date(`${eventData.endDate}T${eventData.endTime}`);
        
        if (endDateTime <= startDateTime) {
            errors.push("End time must be after start time");
        }
        
        // Check for overlaps (only for user events, not system events)
        const userEventsForCheck = userEvents.filter(e => 
            !isEditing || e.id !== eventData.eventId
        );
        
        const eventForCheck = {
            id: eventData.eventId,
            date: eventData.startDate,
            endDate: eventData.endDate,
            startTime: eventData.startTime,
            endTime: eventData.endTime
        };
        
        if (hasTimeOverlap(eventForCheck, userEventsForCheck)) {
            const optimalSlot = findOptimalTimeSlot(eventForCheck, userEventsForCheck);
            if (optimalSlot) {
                errors.push(`Time overlap detected. Suggested slot: ${optimalSlot.startTime} - ${optimalSlot.endTime}`);
            } else {
                errors.push("Time overlap detected and no suitable alternative slot found");
            }
        }
    }
    
    return errors;
}

// Replace the existing saveEvent function with this enhanced version
async function saveEventWithScheduling(e) {
    e.preventDefault();

    if (!currentUser) {
        showNotification("Please login to save events", "error");
        showLoginPage();
        return;
    }

    const eventData = {
        eventTitle: document.getElementById("eventTitle").value.trim(),
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        startTime: document.getElementById("modalStartTime").value || "09:00",
        endTime: document.getElementById("modalEndTime").value || "17:00",
        eventCategory: document.getElementById("eventCategory").value,
        eventPriority: document.getElementById("eventPriority").value,
        eventDescription: document.getElementById("eventDescription").value.trim(),
        eventLocation: document.getElementById("eventLocation").value.trim(),
        userId: currentUser.id
    };

    // Enhanced validation with interval scheduling
    const validationErrors = validateEvent(eventData);
    if (validationErrors.length > 0) {
        showNotification(validationErrors.join(". "), "error");
        
        // If there's a suggested time slot, offer to use it
        const suggestedMatch = validationErrors.find(err => err.includes('Suggested slot:'));
        if (suggestedMatch) {
            const suggestedTime = suggestedMatch.split('Suggested slot: ')[1];
            if (confirm(`Would you like to use the suggested time slot: ${suggestedTime}?`)) {
                const [startTime, endTime] = suggestedTime.split(' - ');
                document.getElementById("modalStartTime").value = startTime;
                document.getElementById("modalEndTime").value = endTime;
                // Retry saving with suggested time
                setTimeout(() => saveEventWithScheduling(e), 100);
            }
        }
        return;
    }

    // Continue with original save logic...
    const saveBtn = document.querySelector('#eventForm button[type="submit"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    try {
        // Handle photo upload
        const photoFile = document.getElementById("eventPhoto").files[0];
        if (photoFile) {
            eventData.eventPhoto = photoFile;
        }

        const result = await saveEventToDatabase(eventData);
        
        // Create complete event object
        const newEvent = {
            id: result.eventId,
            title: eventData.eventTitle,
            date: eventData.startDate,
            endDate: eventData.endDate,
            startTime: eventData.startTime,
            endTime: eventData.endTime,
            category: eventData.eventCategory,
            priority: eventData.eventPriority,
            description: eventData.eventDescription,
            location: eventData.eventLocation,
            photo: result.photo_url || '',
            userId: currentUser.id
        };

        // Update local arrays
        await updateLocalEvents(newEvent);
        
        // Update UI
        refreshAllEventDisplays();
        
        // Reset form
        document.getElementById("eventForm").reset();
        document.getElementById("photoPreview").style.display = "none";

        showNotification("Event saved successfully with optimal scheduling!", "success");
        
        // Auto-switch to My Events page
        setTimeout(() => {
            showPage("my-events");
        }, 1000);

    } catch (error) {
        console.error('Save event error:', error);
        showNotification("Failed to save event: " + error.message, "error");
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// Enhanced calendar rendering with conflict indicators
function renderCalendarWithConflicts() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update current month display
    currentMonthElement.textContent = `${currentDate.toLocaleString("default", { month: "long" })} ${year}`;

    // Clear previous calendar
    calendarGrid.innerHTML = "";

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Create empty cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement("div");
        emptyDay.classList.add("calendar-day", "empty-day");
        emptyDay.innerHTML = '<div class="empty-state"> </div>';
        calendarGrid.appendChild(emptyDay);
    }

    // Create cells for each day of the month
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement("div");
        dayElement.classList.add("calendar-day");

        // Format date for this day
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        // Check if this day is today
        const currentDay = new Date(dateStr);
        currentDay.setHours(0, 0, 0, 0);
        if (currentDay.getTime() === today.getTime()) {
            dayElement.classList.add("today");
        }

        // Check for scheduling conflicts on this day
        const dayEvents = getEventsForDate(dateStr);
        const hasConflicts = checkDayForConflicts(dayEvents);
        if (hasConflicts) {
            dayElement.classList.add("has-conflicts");
            dayElement.style.borderColor = "var(--danger)";
        }

        // Day header with number and add button
        const dayHeader = document.createElement("div");
        dayHeader.classList.add("day-header");

        const dayNumber = document.createElement("span");
        dayNumber.classList.add("day-number");
        dayNumber.textContent = day;

        // Add conflict indicator
        if (hasConflicts) {
            const conflictBadge = document.createElement("span");
            conflictBadge.classList.add("conflict-badge");
            conflictBadge.innerHTML = "";
            conflictBadge.title = "Scheduling conflicts detected";
            conflictBadge.style.marginLeft = "5px";
            conflictBadge.style.fontSize = "0.8em";
            dayNumber.appendChild(conflictBadge);
        }

        const addButton = document.createElement("button");
        addButton.classList.add("add-event-btn");
        addButton.innerHTML = "<i class='fas fa-plus'></i>";
        addButton.title = "Add Event on " + dateStr;
        addButton.addEventListener("click", (e) => {
            e.stopPropagation();
            openAddEventModal(dateStr);
        });

        dayHeader.appendChild(dayNumber);
        dayHeader.appendChild(addButton);
        dayElement.appendChild(dayHeader);

        // Show event count badge if there are events
        if (dayEvents.length > 0) {
            const eventCount = document.createElement("div");
            eventCount.classList.add("event-count");
            eventCount.textContent = dayEvents.length;
            eventCount.title = `${dayEvents.length} events`;
            dayElement.appendChild(eventCount);
        }

        // Events container
        const eventsContainer = document.createElement("div");
        eventsContainer.classList.add("events-container");

        if (dayEvents.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.classList.add("empty-state");
            emptyState.textContent = "";
            eventsContainer.appendChild(emptyState);
        } else {
            dayEvents.forEach(event => {
                const eventElement = document.createElement("div");
                eventElement.classList.add("event", `event-${event.category || 'personal'}`);
                
                // Add conflict styling for overlapping events
                if (isEventInConflict(event, dayEvents)) {
                    eventElement.classList.add("conflict-event");
                    eventElement.style.background = "linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)";
                }
                
                eventElement.title = `${event.title} - Click for details`;

                const eventIcon = document.createElement("i");
                eventIcon.className = getEventIcon(event.category);
                eventIcon.style.marginRight = "5px";

                const eventTitle = document.createElement("span");
                eventTitle.textContent = event.title || "Untitled Event";

                eventElement.appendChild(eventIcon);
                eventElement.appendChild(eventTitle);

                // Add click event to view details
                eventElement.addEventListener("click", (e) => {
                    e.stopPropagation();
                    openEventDetails(event);
                });

                eventsContainer.appendChild(eventElement);
            });
        }

        dayElement.appendChild(eventsContainer);
        calendarGrid.appendChild(dayElement);
    }
}

// Check for conflicts in a day's events
function checkDayForConflicts(dayEvents) {
    if (dayEvents.length < 2) return false;
    
    // Only check user events (not system events)
    const userEvents = dayEvents.filter(event => !event.isSystemEvent);
    
    for (let i = 0; i < userEvents.length; i++) {
        for (let j = i + 1; j < userEvents.length; j++) {
            if (hasTimeOverlap(userEvents[i], [userEvents[j]])) {
                return true;
            }
        }
    }
    return false;
}

// Check if a specific event is in conflict
function isEventInConflict(targetEvent, dayEvents) {
    if (!targetEvent.startTime || !targetEvent.endTime) return false;
    
    const otherEvents = dayEvents.filter(event => 
        event.id !== targetEvent.id && !event.isSystemEvent
    );
    
    return hasTimeOverlap(targetEvent, otherEvents);
}

// Replace the existing functions with enhanced versions
const originalSaveEvent = saveEvent;
saveEvent = saveEventWithScheduling;

const originalRenderCalendar = renderCalendar;
renderCalendar = renderCalendarWithConflicts;

// Add CSS for conflict styling
const conflictStyles = `
<style>
.calendar-day.has-conflicts {
    border: 2px solid var(--danger) !important;
    background: linear-gradient(135deg, #fff5f5 0%, #ffffff 50%) !important;
}

.conflict-badge {
    color: var(--danger);
    font-weight: bold;
}

.conflict-event {
    animation: pulse-conflict 2s infinite;
    border-left: 3px solid var(--danger) !important;
}

@keyframes pulse-conflict {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.scheduling-suggestion {
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
    font-size: 0.9em;
}

.suggestion-accept {
    background: var(--primary);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
}
</style>
`;

// Add the styles to the document
document.head.insertAdjacentHTML('beforeend', conflictStyles);

console.log("Enhanced Interval Scheduling Algorithm initialized");
</script>
    <script src="js/script.js"></script>
    <script src="animation.js"></script>
</body>
</html>